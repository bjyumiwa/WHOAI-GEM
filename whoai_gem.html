<!DOCTYPE html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>WHOAI Gem</title>

<style>
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:"Noto Sans JP",system-ui,sans-serif}
  .stage{position:relative;height:100%;overflow:hidden;user-select:none;-webkit-user-select:none}
  .bg{position:absolute;inset:0;background-size:cover;background-position:center;opacity:1;transition:opacity .8s ease}
  .bg.hide{opacity:0}
  .veil{position:absolute;inset:0;background:linear-gradient(to top, rgba(0,0,0,.45), rgba(0,0,0,.1));pointer-events:none}

  .whoai{position:absolute;left:18px;bottom:92px;width:140px;filter:drop-shadow(0 6px 12px rgba(0,0,0,.6))}
  .hop{animation:hop 1.8s ease-in-out infinite}
  @keyframes hop{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}

  .bucket{position:absolute;right:18px;bottom:86px;width:160px}
  .bucket img{width:100%;display:block}
  .count{position:absolute;right:15px;bottom:152px;background:#fff;color:#111;border-radius:999px;padding:4px 10px;font-weight:700;box-shadow:0 4px 12px rgba(0,0,0,.4)}

  #sandWrap{position:absolute;inset:0}
  canvas{position:absolute;left:0;top:0}

  .hud{position:absolute;left:0;right:0;bottom:0;display:flex;gap:8px;justify-content:center;align-items:center;padding:10px;background:rgba(0,0,0,.28);backdrop-filter:blur(4px)}
  .btn{background:#fff;color:#111;border:0;border-radius:999px;padding:8px 14px;font-weight:700;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}

  .toast{position:absolute;left:12px;top:12px;background:rgba(0,0,0,.28);backdrop-filter:blur(4px);padding:8px 12px;border-radius:12px;max-width:min(86ch,92vw)}

  .modal{position:absolute;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55)}
  .modal.active{display:grid}
  .card{width:min(560px,92vw);background:#111;border:1px solid #333;border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.5)}
  .card h3{margin:.2em 0 6px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(88px,1fr));gap:10px;margin-top:10px}
  .thumb{background:#222;border:1px solid #333;border-radius:12px;padding:8px;display:grid;place-items:center}
  .thumb img{max-width:72px;max-height:72px}

  .lang{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.28);backdrop-filter:blur(4px);border-radius:10px;padding:6px}
  .lang select{background:#111;color:#fff;border:1px solid #333;border-radius:8px;padding:4px 6px}
  .about{position:absolute;top:10px;left:10px;background:rgba(0,0,0,.28);backdrop-filter:blur(4px);border-radius:10px;padding:6px}
  .about a{color:#fff;text-decoration:none;font-weight:700}
</style>

<body>
<div class="stage" id="stage">
  <div class="about"><a href="about/index.html" data-i18n="link.about"></a></div>
  <div class="lang">
    <label>
      <select id="langSel" aria-label="language">
        <option value="ja">日本語</option>
        <option value="en">English</option>
      </select>
    </label>
  </div>

  <div id="bg-sunrise" class="bg" style="background-image:url('public/bg/sunrise.jpg')"></div>
  <div id="bg-beach"   class="bg hide" style="background-image:url('public/bg/beach_day.jpg')"></div>
  <div id="bg-night"   class="bg hide" style="background-image:url('public/bg/night_beach.jpg')"></div>
  <div class="veil"></div>

  <img id="whoai" class="whoai hop" src="assets/steag1/green_open.png" alt="whoai">

  <div class="bucket"><img src="public/props/bucket.png" alt="bucket"></div>
  <div id="count" class="count">0</div>

  <div id="sandWrap" class="hide">
    <canvas id="sand"></canvas>
    <canvas id="mask"></canvas>
  </div>

  <div id="toast" class="toast" data-i18n="toast.sunrise"></div>

  <div class="hud">
    <button class="btn" id="btnStart" data-i18n="btn.start"></button>
    <button class="btn" id="btnCook" data-i18n="btn.cook" disabled></button>
    <button class="btn" id="btnAcc" data-i18n="btn.acc" disabled></button>
    <button class="btn" id="btnCol" data-i18n="btn.col"></button>
    <button class="btn" id="btnNight" data-i18n="btn.night"></button>
  </div>

  <div id="modal" class="modal">
    <div class="card">
      <h3 id="modalTitle" data-i18n="modal.cook.title"></h3>
      <div id="modalBody" style="line-height:1.8;opacity:.95"></div>
      <div id="modalGrid" class="grid"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn" id="btnClose" data-i18n="close"></button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== i18n loader ===== */
const I18N = { cur:'ja', dict:{} };
async function setLang(lang){
  I18N.cur = (lang || navigator.language || 'ja').slice(0,2);
  if(!['ja','en'].includes(I18N.cur)) I18N.cur='ja';
  const res = await fetch(`i18n/${I18N.cur}.json`);
  I18N.dict = await res.json();
  applyI18n();
}
function t(key, vars={}){
  let s = I18N.dict[key] || key;
  for(const k in vars){ s = s.replaceAll(`{${k}}`, String(vars[k])); }
  return s;
}
function applyI18n(){
  document.title = t('title');
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    el.textContent = t(key);
  });
  // 初期トースト
  document.getElementById('toast').textContent = t('toast.sunrise');
}

/* ===== assets ===== */
const WHOAI_DIR = "assets/steag1/";
const WHOAI_LIST = [
  "blue_closed.png","green_open.png","orange_closed.png",
  "pink_closed.png","purple_closed.png",
  "tane_green.png","tane_pink.png","tane_purple.png","tane_blue.png"
].map(n=>WHOAI_DIR+n);

const COMMON = [
  "public/items/asari1.png",
  "public/items/asari2.png",
  "public/items/asari3.png"
];
const RARE = [
  "public/items/aurora_shell.png",
  "public/items/flame_shell.png",
  "public/items/luminous_shell.png",
  "public/items/mystic_shell.png",
  "public/items/night_sky_shell.png",
  "public/items/rare_pearl.png",
  "public/items/rare_rainbow.png",
  "public/items/wave_shell.png"
];

/* ===== scene and UI ===== */
const bg = {
  sunrise: document.getElementById('bg-sunrise'),
  beach:   document.getElementById('bg-beach'),
  night:   document.getElementById('bg-night'),
};
const whoai = document.getElementById('whoai');
const toast = (txt)=> document.getElementById('toast').textContent = txt;
const countEl = document.getElementById('count');

function setScene(name){
  for(const k in bg) bg[k].classList.add('hide');
  if(name==='sunrise'){ bg.sunrise.classList.remove('hide'); whoai.classList.add('hop'); toast(t('toast.sunrise')); }
  if(name==='beach'){   bg.beach.classList.remove('hide'); whoai.classList.remove('hop'); toast(t('toast.beach')); }
  if(name==='night'){   bg.night.classList.remove('hide'); whoai.classList.remove('hop'); toast(t('toast.night')); }
}

/* ===== scratch sand ===== */
const sandWrap = document.getElementById('sandWrap');
const sandCanvas = document.getElementById('sand');
const maskCanvas = document.getElementById('mask');
const sctx = sandCanvas.getContext('2d');
const mctx = maskCanvas.getContext('2d');
let W=0,H=0, shells=[], foundToday=[];

function resize(){
  W = sandWrap.clientWidth = window.innerWidth;
  H = sandWrap.clientHeight = window.innerHeight;
  sandCanvas.width=W; sandCanvas.height=H;
  maskCanvas.width=W; maskCanvas.height=H;
  drawSand();
}
function drawSand(){
  const grad = sctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0,"rgba(230,202,150,0.90)");
  grad.addColorStop(1,"rgba(215,186,138,0.92)");
  sctx.fillStyle = grad; sctx.fillRect(0,0,W,H);
  for(let i=0;i<600;i++){
    const a = Math.random()*0.08+0.02;
    sctx.fillStyle=`rgba(0,0,0,${a})`;
    sctx.fillRect(Math.random()*W, Math.random()*H, 1, 1);
  }
  mctx.clearRect(0,0,W,H);
}
function spawnShells(n=6){
  shells = [];
  for(let i=0;i<n;i++){
    const src = Math.random()<0.22 ? pick(RARE) : pick(COMMON);
    shells.push({x:W*(0.18+Math.random()*0.64), y:H*(0.55+Math.random()*0.28), img:src, found:false});
  }
}
function preload(list){ return Promise.all(list.map(src=>new Promise(r=>{ const im=new Image(); im.onload=()=>r(im); im.src=src; }))); }
function pick(a){ return a[Math.floor(Math.random()*a.length)] }

let drawing=false, lastX=0, lastY=0;
function startDraw(x,y){ drawing=true; lastX=x; lastY=y; scratch(x,y,28); checkReveal(x,y); }
function moveDraw(x,y){ if(!drawing) return; scratchLine(lastX,lastY,x,y,28); lastX=x; lastY=y; checkReveal(x,y); }
function endDraw(){ drawing=false; }

function scratch(x,y,r){
  mctx.globalCompositeOperation='source-over';
  mctx.fillStyle='rgba(0,0,0,1)';
  mctx.beginPath(); mctx.arc(x,y,r,0,Math.PI*2); mctx.fill();

  sctx.globalCompositeOperation='destination-out';
  sctx.drawImage(maskCanvas,0,0);
  sctx.globalCompositeOperation='source-over';
  mctx.clearRect(0,0,W,H);
}
function scratchLine(x1,y1,x2,y2,r){
  const dx=x2-x1, dy=y2-y1, dist=Math.hypot(dx,dy);
  const steps = Math.ceil(dist/(r*0.6));
  for(let i=0;i<=steps;i++){
    const t=i/steps; scratch(x1+dx*t, y1+dy*t, r);
  }
}

/* ===== reveal and animate ===== */
function checkReveal(x,y){
  const t=40;
  for(const sh of shells){
    if(sh.found) continue;
    if(Math.abs(sh.x-x)<t && Math.abs(sh.y-y)<t){
      sh.found=true;
      riseAndFlyToBucket(sh);
      foundToday.push(sh.img);
      updateCount();
      enableButtons();
    }
  }
}
function updateCount(){ countEl.textContent = String(foundToday.length); }
function riseAndFlyToBucket(sh){
  const el = document.createElement('img');
  el.src = sh.img;
  el.style.position='absolute';
  el.style.left = (sh.x-36)+'px';
  el.style.top  = (sh.y-36)+'px';
  el.style.width='72px';
  el.style.pointerEvents='none';
  el.style.filter='drop-shadow(0 8px 14px rgba(0,0,0,.6))';
  document.body.appendChild(el);

  const b = document.querySelector('.bucket').getBoundingClientRect();
  const tx = b.left + b.width*0.45;
  const ty = b.top + b.height*0.15;

  el.animate([
    {transform:'translateY(0) scale(1)', opacity:0},
    {transform:'translateY(-18px) scale(1.05)', opacity:1, offset:.25},
    {transform:`translate(${tx - sh.x}px, ${ty - sh.y}px) scale(.6)`, opacity:.9}
  ], {duration:900, easing:'cubic-bezier(.2,.9,.25,1)'}).onfinish = ()=> el.remove();

  try{ new Audio('public/audio/puton.mp3').play(); }catch{}
}

/* ===== modal ===== */
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const modalGrid = document.getElementById('modalGrid');
document.getElementById('btnClose').onclick=()=>modal.classList.remove('active');

function openModal(title, html, imgs=[]){
  modalTitle.textContent=title;
  modalBody.innerHTML=html;
  modalGrid.innerHTML='';
  imgs.forEach(src=>{
    const d=document.createElement('div'); d.className='thumb';
    const im=new Image(); im.src=src; d.appendChild(im);
    modalGrid.appendChild(d);
  });
  modal.classList.add('active');
}

/* ===== cooking / accessory / collection ===== */
function decideDish(imgs){
  const rare = imgs.filter(x=>RARE.includes(x)).length;
  if(rare>=1 && imgs.length>=2) return I18N.cur==='ja' ? 'ボンゴレ・ビアンコ' : 'Vongole Bianco';
  if(imgs.length>=4)           return I18N.cur==='ja' ? 'アサリの酒蒸し'     : 'Sakamushi (Steamed Clams)';
  return I18N.cur==='ja' ? 'アサリの味噌汁' : 'Miso Soup with Clams';
}
function fortuneFor(dish){
  // dishは言語別表記なので判定は含意で
  if(dish.includes('Vongole') || dish.includes('ボンゴレ')) return t('fortune.vongole');
  if(dish.includes('Sakamushi') || dish.includes('酒蒸し')) return t('fortune.sakamushi');
  return t('fortune.miso');
}
function enableButtons(){
  document.getElementById('btnCook').disabled = foundToday.length===0;
  document.getElementById('btnAcc').disabled  = foundToday.length<3;
}

/* ===== events ===== */
document.getElementById('btnStart').onclick = async ()=>{
  setScene('beach');
  document.getElementById('btnStart').disabled=true;
  sandWrap.classList.remove('hide');
  resize();
  spawnShells(6);
  preload([...COMMON, ...RARE, ...WHOAI_LIST]);
};
document.getElementById('btnNight').onclick=()=> setScene('night');

document.getElementById('btnCook').onclick=()=>{
  const dish = decideDish(foundToday);
  const msg  = fortuneFor(dish);
  openModal(t('modal.cook.title'), `${t('cook.result',{dish})}<br>${msg}`, foundToday.slice(0,6));
};
document.getElementById('btnAcc').onclick=()=>{
  const n = foundToday.length;
  const gradeKey = n>=10 ? 'grade.crown' : n>=5 ? 'grade.pierce' : 'grade.necklace';
  openModal(t('modal.acc.title'), t('acc.summary',{count:n, grade:t(gradeKey)}), foundToday.slice(0,6));
};
document.getElementById('btnCol').onclick=()=>{
  const key = 'whoai_gem_collections';
  const box = JSON.parse(localStorage.getItem(key)||'[]');
  const today = (new Date()).toISOString().slice(0,10);
  if(foundToday[0]) box.push({date:today, img:foundToday[0]});
  localStorage.setItem(key, JSON.stringify(box));
  openModal(t('modal.col.title'), t('col.title2'), box.slice(-12).map(x=>x.img));
};

window.addEventListener('resize', ()=>{ if(!sandWrap.classList.contains('hide')) resize(); });
sandWrap.addEventListener('pointerdown', e=>{ sandWrap.setPointerCapture(e.pointerId); startDraw(e.clientX, e.clientY); });
sandWrap.addEventListener('pointermove', e=> moveDraw(e.clientX, e.clientY));
sandWrap.addEventListener('pointerup',   ()=> endDraw());
sandWrap.addEventListener('pointerleave',()=> endDraw());

document.getElementById('langSel').addEventListener('change', e=> setLang(e.target.value));

setLang();            // 言語初期化
setScene('sunrise');  // 起動時は朝
document.getElementById('btnStart').textContent = t('btn.start');
document.getElementById('btnCook').textContent  = t('btn.cook');
document.getElementById('btnAcc').textContent   = t('btn.acc');
document.getElementById('btnCol').textContent   = t('btn.col');
document.getElementById('btnNight').textContent = t('btn.night');
document.getElementById('btnClose').textContent = t('close');
</script>
</body>
</html>

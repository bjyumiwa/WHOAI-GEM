<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>WHOAI Gem</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
  /* 各種スタイル（前版と共通）省略、必要であれば追加します */
  body,html{margin:0;padding:0;height:100%;overflow:hidden;font-family:sans-serif;background:#000;color:#fff;touch-action:none;}
  .bg{position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-position:center;transition:opacity 1s}
  .hide{opacity:0;pointer-events:none;}
  #titleScreen{position:absolute;...} /* 同様のスタイル省略 */
  /* ... */
</style>
</head>
<body>
  <!-- 背景 -->
  <div id="bg-sunrise" class="bg" style="background-image:url('./public/bg/sunrise.jpg')"></div>
  <div id="bg-beach"   class="bg hide" style="background-image:url('./public/bg/beach_day.jpg')"></div>
  <div id="bg-night"   class="bg hide" style="background-image:url('./public/bg/night_beach.jpg')"></div>

  <!-- タイトル -->
  <div id="titleScreen">
    <h1>WHOAI Gem</h1>
    <button id="btnTitleStart">スタート</button>
    <button id="btnContinue" style="margin-top:10px;">続きから</button>
  </div>

  <!-- キャラ・貝・バケツ・砂Canvas・UI -->
  <img id="whoai" class="hide" src="./public/assets/stage1/green_open.png" alt="whoai">
  <div class="bucket"><img id="bucketImg" src="./public/bucket.png" alt="bucket"></div>
  <div id="counter">0</div>
  <canvas id="sand" class="hide"></canvas>
  <div id="toast"></div>
  <div class="ui">
    <button id="btnStart">はじめに</button>
    <button id="btnReset">リセット</button>
    <button id="btnNight">夜へ</button>
  </div>
  <script>
    // 状態
    let count = 0, whoaiName = "WHOAI", macaronGiven = false, currentScene = "sunrise";

    // ローカル保存／復元
    function saveState(){
      localStorage.setItem("whoaiName", whoaiName);
      localStorage.setItem("count", count);
    }
    function loadState(){
      const n = localStorage.getItem("whoaiName");
      const c = localStorage.getItem("count");
      if(n) whoaiName = n;
      if(c) { count = parseInt(c); document.getElementById("counter").textContent = count; }
    }
    function resetState(){
      count = 0; macaronGiven = false;
      whoaiName = "WHOAI";
      localStorage.removeItem("count");
      localStorage.removeItem("whoaiName");
      document.getElementById("counter").textContent = 0;
      document.querySelectorAll(".shell, .macaron").forEach(e=>e.remove());
      initSand();
    }

    // シーン切替
    function showScene(id){
      currentScene = id.includes("night") ? "night" : "day";
      document.querySelectorAll(".bg").forEach(bg=>bg.classList.add("hide"));
      document.getElementById(id).classList.remove("hide");
      if(id==="bg-beach"){
        document.getElementById("sand").classList.remove("hide");
        initSand(); spawnShells(5); wanderWhoai();
        showSpeech("砂をよけて、貝を探してね", true);
      }
      if(id==="bg-night"){
        askName();
      }
    }

    // 吹き出し
    function showSpeech(text, sticky=false){
      const w = document.getElementById("whoai"), r = w.getBoundingClientRect();
      const sp = document.createElement("div");
      sp.className = `speech ${currentScene}`;
      sp.textContent = text;
      sp.style.left = (r.left + r.width/2) + "px";
      sp.style.top = r.top + "px";
      document.body.appendChild(sp);
      if(!sticky) setTimeout(() => sp.remove(), 2500);
    }

    // 砂Canvas
    const sand = document.getElementById("sand"), ctx = sand.getContext("2d");
    function resizeSand(){ sand.width = innerWidth; sand.height = innerHeight;
      const g = ctx.createLinearGradient(0,0,0,sand.height); g.addColorStop(0,"#e7d9b7");g.addColorStop(1,"#c8b68f");
      ctx.fillStyle = g; ctx.fillRect(0,0,sand.width,sand.height);
    }
    function initSand(){
      resizeSand();
      document.querySelectorAll(".speech").forEach(e=>e.remove());
    }
    function erase(x,y){ ctx.globalCompositeOperation = "destination-out";
      ctx.beginPath(); ctx.arc(x,y,40,0,Math.PI*2); ctx.fill();
      ctx.globalCompositeOperation = "source-over";
      document.querySelectorAll(".speech").forEach(e => e.remove());
      saveState();
    }
    sand.addEventListener("pointerdown",e=>erase(e.clientX,e.clientY));
    sand.addEventListener("pointermove",e=>{ if(e.buttons) erase(e.clientX,e.clientY); });

    // 貝とマカロン
    const COMMON = ["./public/items/asari1.png","./public/items/asari2.png","./public/items/asari3.png"];
    const MACARONS = ["./public/items/macaroon1.png","./public/items/macaroon2.png","./public/items/macaroon3.png"];
    function spawnShells(n=5){ for(let i=0;i<n;i++){
      if(Math.random()<0.4) continue; const img = COMMON[Math.floor(Math.random()*COMMON.length)];
      const shell = document.createElement("div"); shell.className = "shell";
      shell.style.backgroundImage = `url(${img})`;
      shell.style.left = (Math.random()*70+10)+"%";
      shell.style.top = (Math.random()*40+40)+"%";
      document.body.appendChild(shell);
      makeDraggable(shell);
    }}
    function spawnMacaron(){
      if(macaronGiven) return;
      macaronGiven = true;
      const img = MACARONS[Math.floor(Math.random()*MACARONS.length)];
      const mac = document.createElement("div"); mac.className = "macaron";
      mac.style.backgroundImage = `url(${img})`;
      mac.style.left = (Math.random()*70+10)+"%";
      mac.style.top = (Math.random()*40+30)+"%";
      document.body.appendChild(mac);
    }

    // ドラッグ処理
    function makeDraggable(el){
      let dragging=false, offX=0, offY=0;
      el.addEventListener("pointerdown",e=>{dragging=true;offX=e.clientX-el.offsetLeft;offY=e.clientY-el.offsetTop;});
      window.addEventListener("pointermove",e=>{ if(!dragging)return; el.style.left=(e.clientX-offX)+"px";el.style.top=(e.clientY-offY)+"px"; });
      window.addEventListener("pointerup",()=>{
        if(!dragging)return; dragging=false;
        const b = document.getElementById("bucketImg").getBoundingClientRect();
        const r = el.getBoundingClientRect();
        if(r.left<b.right && r.right>b.left && r.top<b.bottom && r.bottom>b.top){
          el.remove(); count++; document.getElementById("counter").textContent = count;
          showSpeech("やったね!");
          if(count === 10){ showSpeech("ご褒美！マカロンをゲット"); spawnMacaron(); }
          saveState();
        }
      });
    }

    // キャラの移動
    function wanderWhoai(){
      const w = document.getElementById("whoai"); w.classList.remove("hide");
      setInterval(()=>{
        w.style.left = Math.random()*70+10+"%";
        w.style.bottom = (10+Math.random()*60)+"vh";
      }, 5000);
    }

    // 会話（API呼び出しあれば）
    async function askName(){
      const name = prompt("キャラに名前をつけてください", whoaiName);
      if(name) whoaiName = name;
      showSpeech(`${whoaiName}「またあした。星を見ながら語ろう」`);
      saveState();
    }
    // API 呼び出し例（存在すれば呼ぶ）
    async function talkAPI(msg){
      try{
        if(window.talkApi) {
          return await talkApi(msg);
        }
      } catch(e){}
      return "いい一日でしたね。";
    }

    // コントロール
    document.getElementById("btnTitleStart").onclick = ()=>{document.getElementById("titleScreen").style.display="none"; showScene("bg-sunrise");};
    document.getElementById("btnContinue").onclick = ()=>{ loadState(); document.getElementById("titleScreen").style.display="none"; showScene("bg-sunrise"); };
    document.getElementById("btnStart").onclick = ()=>showScene("bg-beach");
    document.getElementById("btnNight").onclick = ()=>{ showScene("bg-night"); askName(); };
    document.getElementById("btnReset").onclick = ()=>{ resetState(); showSpeech("リセットしたよ",true); };

    // 初期化
    resizeSand(); loadState();
  </script>
</body>
</html>

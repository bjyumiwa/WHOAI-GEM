<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title data-i18n="title">WHOAI Gem</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    body,html{
      margin:0;padding:0;overflow:hidden;height:100%;
      font-family:sans-serif;background:#000;color:#fff;
      touch-action:none;
    }
    .bg{
      position:absolute;top:0;left:0;width:100%;height:100%;
      background-size:cover;background-position:center;
      transition:opacity 1s;
    }
    .hide{opacity:0;pointer-events:none}

    .whoai{
      position:absolute;
      bottom:12vh;left:10vw;
      width:clamp(80px,12vw,140px);
      animation:hop 2s infinite;
      user-select:none;
      transition:all 4s ease-in-out;
    }
    @keyframes hop{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}

    .bucket{
      position:absolute;right:2vw;bottom:6vh;
      width:clamp(72px,14vw,140px);user-select:none;
    }
    .bucket img{display:block;width:100%;height:auto}

    #counter{
      position:absolute;
      right:calc(2vw + 40px); bottom:calc(6vh + 40px);
      font-size:clamp(16px,2vw,24px);
      background:#fff;color:#111;
      padding:6px 12px;border-radius:50%;
      text-align:center;
    }

    .ui{
      position:absolute;bottom:10px;left:50%;
      transform:translateX(-50%);display:flex;gap:6px;z-index:10;
    }
    .ui button{padding:6px 10px;border-radius:12px;border:none;cursor:pointer}

    #toast{
      position:absolute;top:10px;left:10px;
      background:rgba(0,0,0,0.6);padding:6px 12px;border-radius:6px;z-index:10;
    }

    #langSel{position:absolute;top:10px;right:10px;z-index:10}

    .shell,.macaron{
      position:absolute;width:60px;height:60px;
      background-size:contain;background-repeat:no-repeat;background-position:center;
      cursor:grab;user-select:none;touch-action:none;
    }

    .speech{
      position:absolute;
      padding:6px 12px;border-radius:12px;
      font-size:14px;white-space:nowrap;
      animation:fadeout 3s forwards;
    }
    .speech.day{background:#fff;color:#000;}
    .speech.night{background:#fff;color:#000;} /* 夜は白背景黒文字 */

    @keyframes fadeout{
      0%{opacity:1;transform:translate(-50%,-100%)}
      100%{opacity:0;transform:translate(-50%,-150%)}
    }
  </style>
</head>
<body>
  <!-- 背景 -->
  <div id="bg-sunrise" class="bg" style="background-image:url('./public/bg/sunrise.jpg')"></div>
  <div id="bg-beach"   class="bg hide" style="background-image:url('./public/bg/beach_day.jpg')"></div>
  <div id="bg-night"   class="bg hide" style="background-image:url('./public/bg/night_beach.jpg')"></div>

  <!-- WHOAIキャラ -->
  <img id="whoai" class="whoai hide" src="./public/assets/stage1/green_open.png" alt="whoai">

  <!-- バケツ -->
  <div class="bucket"><img id="bucketImg" src="./public/bucket.png" alt="bucket"></div>
  <div id="counter">0</div>

  <!-- UI -->
  <div id="toast"></div>
  <div class="ui">
    <button id="btnStart" data-i18n="btn.start">はじめる</button>
    <button id="btnCook" data-i18n="btn.cook">料理</button>
    <button id="btnAcc"  data-i18n="btn.acc">アクセサリー</button>
    <button id="btnCol"  data-i18n="btn.col">コレクション</button>
    <button id="btnNight" data-i18n="btn.night">夜へ</button>
  </div>
  <select id="langSel" aria-label="language">
    <option value="ja">日本語</option>
    <option value="en">English</option>
    <option value="ko">한국어</option>
    <option value="zh">中文</option>
  </select>

<script>
// ---------------- i18n ----------------
async function setLang(lang){
  if(!['ja','en','ko','zh'].includes(lang)) lang='ja';
  const res=await fetch(`./i18n/${lang}.json`);
  I18N=await res.json();curLang=lang;applyI18n();
}
let I18N={},curLang="ja";
function t(key){return I18N[key]||key;}
function applyI18n(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    el.textContent=t(el.dataset.i18n);
  });
}
document.getElementById("langSel").onchange=e=>setLang(e.target.value);

// ---------------- State ----------------
let count=0;
let whoaiName="WHOAI";
let macaronGiven=false;

// ---------------- Toast ----------------
const toast=document.getElementById("toast");
function showToast(key){toast.textContent=t(key);}

// ---------------- Scenes ----------------
let currentScene="sunrise";
function showScene(id,msg){
  currentScene=id.includes("night")?"night":"day";
  document.querySelectorAll(".bg").forEach(bg=>bg.classList.add("hide"));
  document.getElementById(id).classList.remove("hide");
  showToast(msg);
  if(id==="bg-beach"){ 
    document.getElementById("whoai").classList.remove("hide"); 
    wanderWhoai(); spawnShells(6); 
  }
  if(id==="bg-night"){ askName(); }
}

// ---------------- Shells ----------------
const COMMON=["./public/items/asari1.png","./public/items/asari2.png","./public/items/asari3.png"];
const MACARONS=["./public/items/macaroon1.png","./public/items/macaroon2.png","./public/items/macaroon3.png"];

function spawnShells(n=5){
  for(let i=0;i<n;i++){
    if(Math.random()<0.4) continue;
    const img=COMMON[Math.floor(Math.random()*COMMON.length)];
    const shell=document.createElement("div");
    shell.className="shell";
    shell.style.backgroundImage=`url(${img})`;
    shell.style.left=(Math.random()*70+10)+"%";
    shell.style.top=(Math.random()*40+50)+"%";
    document.body.appendChild(shell);
    makeDraggable(shell);
  }
}

function spawnMacaron(){
  if(macaronGiven) return;
  macaronGiven=true;
  const img=MACARONS[Math.floor(Math.random()*MACARONS.length)];
  const mac=document.createElement("div");
  mac.className="macaron";
  mac.style.backgroundImage=`url(${img})`;
  mac.style.left=(Math.random()*70+10)+"%";
  mac.style.top=(Math.random()*40+30)+"%";
  document.body.appendChild(mac);
}

// ---------------- Draggable ----------------
function makeDraggable(el){
  let offsetX,offsetY,dragging=false;
  function onDown(e){
    dragging=true;
    offsetX=(e.touches?e.touches[0].clientX:e.clientX)-el.offsetLeft;
    offsetY=(e.touches?e.touches[0].clientY:e.clientY)-el.offsetTop;
    e.preventDefault();
  }
  function onMove(e){
    if(!dragging)return;
    const x=(e.touches?e.touches[0].clientX:e.clientX)-offsetX;
    const y=(e.touches?e.touches[0].clientY:e.clientY)-offsetY;
    el.style.left=x+"px";el.style.top=y+"px";
  }
  function onUp(){
    if(!dragging)return;dragging=false;
    const bucket=document.getElementById("bucketImg").getBoundingClientRect();
    const rect=el.getBoundingClientRect();
    if(rect.left<bucket.right && rect.right>bucket.left &&
       rect.top<bucket.bottom && rect.bottom>bucket.top){
      el.remove();count++;
      document.getElementById("counter").textContent=count;
      showSpeech("やったね！");
      if(count===10){ showSpeech("ご褒美！マカロンをゲット"); spawnMacaron(); }
    }
  }
  el.addEventListener("mousedown",onDown);
  el.addEventListener("touchstart",onDown,{passive:false});
  window.addEventListener("mousemove",onMove);
  window.addEventListener("touchmove",onMove,{passive:false});
  window.addEventListener("mouseup",onUp);
  window.addEventListener("touchend",onUp);
}

// ---------------- WHOAI speech ----------------
function showSpeech(text){
  const whoai=document.getElementById("whoai");
  const rect=whoai.getBoundingClientRect();
  const sp=document.createElement("div");
  sp.className=`speech ${currentScene}`;
  sp.textContent=text;
  sp.style.left=(rect.left+rect.width/2)+"px";
  sp.style.top=rect.top+"px";
  document.body.appendChild(sp);
  setTimeout(()=>sp.remove(),2500);
}

// ---------------- Random movement ----------------
function wanderWhoai(){
  const whoai=document.getElementById("whoai");
  setInterval(()=>{
    whoai.style.left=Math.random()*70+10+"%";
    whoai.style.bottom=(10+Math.random()*10)+"vh";
  },5000);
}

// ---------------- Name at night ----------------
function askName(){
  const name=prompt("キャラに名前をつけてください",whoaiName);
  if(name) whoaiName=name;
  showSpeech(`${whoaiName}「またあした。星を見ながら語ろう」`);
}

// ---------------- Buttons ----------------
document.getElementById("btnStart").onclick=()=>showScene("bg-beach","toast.beach");
document.getElementById("btnCook").onclick=()=>alert("料理シーンへ");
document.getElementById("btnAcc").onclick=()=>alert("アクセサリーシーンへ");
document.getElementById("btnCol").onclick=()=>alert("コレクションシーンへ");
document.getElementById("btnNight").onclick=()=>showScene("bg-night","toast.night");

// ---------------- Init ----------------
(async()=>{
  await setLang("ja");
  showScene("bg-sunrise","toast.sunrise");
})();
</script>
</body>
</html>

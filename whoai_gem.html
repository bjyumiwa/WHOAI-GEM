<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title data-i18n="title">WHOAI Gem</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  html,body{margin:0;padding:0;height:100%;background:#000;color:#fff;overflow:hidden;font-family:sans-serif}

  /* 背景 */
  .bg{position:absolute;inset:0;background-size:cover;background-position:center;opacity:0;transition:opacity .8s;z-index:0}
  .bg.show{opacity:1}
  .grad-sunrise{background:linear-gradient(#ffdfb5,#f7a7b1 40%,#8fb7ff)}
  .grad-beach{background:linear-gradient(#b6e3ff,#9ad0ff 60%,#f2d7a2)}
  .grad-night{background:radial-gradient(circle at 50% 20%,#1b2b52,#0a1430 70%)}

  /* WHOAIキャラ */
  .whoai{position:absolute;bottom:12vh;left:5vw;width:clamp(80px,12vw,140px);
         animation:hop 2s infinite;z-index:4}
  @keyframes hop{0%,100%{transform:translateY(0)}50%{transform:translateY(-15px)}}

  /* バケツ */
  .bucket{position:absolute;right:2vw;bottom:8vh;width:clamp(72px,14vw,160px);z-index:4}
  .bucket img{width:100%;height:auto;display:block}

  /* UI */
  #counter{position:absolute;right:calc(2vw + 6px);bottom:calc(8vh + 12px);
           font-size:clamp(14px,1.8vw,20px);background:#fff;color:#111;
           padding:4px 8px;border-radius:999px;z-index:5}
  #toast{position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.6);
         padding:6px 12px;border-radius:8px;z-index:11}
  #langSel{position:absolute;top:10px;right:10px;z-index:11}
  .ui{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
      display:flex;gap:6px;z-index:10}
  .ui button{padding:6px 12px;border:none;border-radius:8px;cursor:pointer}

  /* 砂レイヤーと貝 */
  #sandLayer{position:absolute;inset:0;touch-action:none;z-index:2}
  .shell{position:absolute;width:clamp(48px,6vw,72px);height:auto;
         transform:translate(-50%,-50%) scale(.6);
         transition:transform .25s ease,opacity .25s ease;
         opacity:0;cursor:grab;z-index:3}
  .shell.show{transform:translate(-50%,-50%) scale(1);opacity:1}
  .dragging{opacity:.85;cursor:grabbing}
</style>
</head>
<body>
  <!-- 背景（画像が無くてもグラデで代替） -->
  <div id="bg-sunrise" class="bg grad-sunrise"></div>
  <div id="bg-beach"   class="bg grad-beach"></div>
  <div id="bg-night"   class="bg grad-night"></div>

  <!-- WHOAIキャラ -->
  <img id="whoai" class="whoai" src="assets/stage1/green_open.png" alt="whoai">

  <!-- バケツ -->
  <div class="bucket" id="bucket"><img src="public/bucket.png" alt="bucket"></div>
  <div id="counter">0</div>

  <!-- UI -->
  <div id="toast"></div>
  <div class="ui">
    <button id="btnStart">はじめる</button>
    <button id="btnNight">夜へ</button>
  </div>
  <select id="langSel"><option value="ja">日本語</option><option value="en">English</option></select>

  <!-- 砂レイヤー -->
  <canvas id="sandLayer" class="hide"></canvas>

<script>
/* ========== 背景制御 ========== */
const bgEl={
  sunrise:document.getElementById('bg-sunrise'),
  beach:document.getElementById('bg-beach'),
  night:document.getElementById('bg-night')
};
function showOnly(id){Object.values(bgEl).forEach(el=>el.classList.remove('show'));id.classList.add('show');}

/* ========== 状態管理 ========== */
let count=0;
const counterEl=document.getElementById('counter');
const toast=document.getElementById('toast');

/* ========== 砂レイヤー（深さマップつき） ========== */
const sandCanvas=document.getElementById('sandLayer');
const sctx=sandCanvas.getContext('2d',{willReadFrequently:true});
const TILE_SIZE=80; // 深さ判定の1タイルの大きさ
let depthMap={},brushCount={},shellsOnField=[];
const SAND={brush:26,spawnProb:0.25,maxShells:10};

function viewportWH(){return {vw:window.innerWidth,vh:window.innerHeight};}
function resizeSand(){
  const {vw,vh}=viewportWH();
  sandCanvas.width=vw; sandCanvas.height=vh;
  const g=sctx.createLinearGradient(0,0,0,vh);
  g.addColorStop(0,'#D9C8A6'); g.addColorStop(1,'#CBB890');
  sctx.fillStyle=g; sctx.fillRect(0,0,vw,vh);
}
function initDepthMap(){
  depthMap={}; brushCount={};
  const {vw,vh}=viewportWH();
  const cols=Math.ceil(vw/TILE_SIZE), rows=Math.ceil(vh/TILE_SIZE);
  for(let c=0;c<cols;c++)for(let r=0;r<rows;r++){
    const rnd=Math.random(); let d=1;
    if(rnd>0.5) d=2; if(rnd>0.85) d=3;
    depthMap[`${c},${r}`]=d; brushCount[`${c},${r}`]=0;
  }
}
function showSand(){sandCanvas.classList.remove('hide');resizeSand();initDepthMap();}
function hideSand(){sandCanvas.classList.add('hide');shellsOnField.forEach(s=>s.el.remove());shellsOnField=[];}

sandCanvas.addEventListener('pointerdown',e=>{isBrushing=true;brushAt(e);},{passive:false});
sandCanvas.addEventListener('pointermove',e=>{if(isBrushing)brushAt(e);},{passive:false});
sandCanvas.addEventListener('pointerup',()=>isBrushing=false);
sandCanvas.addEventListener('pointercancel',()=>isBrushing=false);

let isBrushing=false;
function brushAt(e){
  const rect=sandCanvas.getBoundingClientRect();
  const x=e.clientX-rect.left, y=e.clientY-rect.top;
  sctx.globalCompositeOperation='destination-out';
  sctx.beginPath(); sctx.arc(x,y,SAND.brush,0,Math.PI*2); sctx.fill();
  sctx.globalCompositeOperation='source-over';
  const col=Math.floor(x/TILE_SIZE), row=Math.floor(y/TILE_SIZE), key=`${col},${row}`;
  if(depthMap[key]){
    brushCount[key]++;
    if(brushCount[key]>=depthMap[key]){
      depthMap[key]=Infinity; // 二度と判定しない
      maybeSpawnShell(x,y);
    }
  }
}

/* ========== 貝の出現 & ドラッグ吸い込み ========== */
const COMMON=["public/items/asari1.png","public/items/asari2.png","public/items/asari3.png"];
const RARE=["public/items/aurora_shell.png","public/items/flame_shell.png","public/items/luminous_shell.png","public/items/mystic_shell.png","public/items/night_sky_shell.png","public/items/rare_pearl.png","public/items/rare_rainbow.png","public/items/wave_shell.png"];
const bucket=document.getElementById('bucket');

function maybeSpawnShell(x,y){
  if(shellsOnField.length>=SAND.maxShells) return;
  if(Math.random()>SAND.spawnProb) return;
  // 出現位置をランダムに散らばらせる
  const spread=80;
  const randX=x+(Math.random()*2-1)*spread;
  const randY=y+(Math.random()*2-1)*spread;
  const vw=window.innerWidth,vh=window.innerHeight;
  const cx=Math.max(40,Math.min(vw-40,randX));
  const cy=Math.max(80,Math.min(vh-80,randY));
  const pool=Math.random()<0.8?COMMON:RARE;
  const src=pool[Math.floor(Math.random()*pool.length)];
  const el=document.createElement('img');
  el.src=src; el.className='shell'; el.style.left=cx+'px'; el.style.top=cy+'px';
  document.body.appendChild(el);
  requestAnimationFrame(()=>el.classList.add('show'));
  enableDrag(el); shellsOnField.push({x:cx,y:cy,el});
}

function enableDrag(el){
  let shiftX=0,shiftY=0;
  el.onpointerdown=e=>{
    e.preventDefault();
    el.classList.add('dragging');
    el.setPointerCapture(e.pointerId);
    const rect=el.getBoundingClientRect();
    shiftX=e.clientX-rect.left; shiftY=e.clientY-rect.top;
    el.onpointermove=ev=>{
      el.style.left=(ev.clientX-shiftX)+"px";
      el.style.top =(ev.clientY-shiftY)+"px";
    };
    el.onpointerup=ev=>{
      el.classList.remove('dragging');
      el.onpointermove=null; el.releasePointerCapture(e.pointerId);
      const b=bucket.getBoundingClientRect(), s=el.getBoundingClientRect();
      const overlap=!(s.right<b.left||s.left>b.right||s.bottom<b.top||s.top>b.bottom);
      if(overlap){el.remove();count++;counterEl.textContent=count;}
    };
  };
}

/* ========== シーン切替 ========== */
function setScene(name){
  Object.values(bgEl).forEach(el=>el.classList.remove('show'));
  shellsOnField.forEach(s=>s.el.remove()); shellsOnField=[];
  if(name==='sunrise'){showOnly(bgEl.sunrise);hideSand();toast.textContent="おはよう";}
  if(name==='beach'){showOnly(bgEl.beach);showSand();toast.textContent="砂をなでてみよう";}
  if(name==='night'){showOnly(bgEl.night);hideSand();toast.textContent="今日はここまで";}
}

/* ========== ボタン ========== */
document.getElementById('btnStart').onclick=()=>setScene('beach');
document.getElementById('btnNight').onclick=()=>setScene('night');

/* 初期表示 */
setScene('sunrise');
</script>
</body>
</html>

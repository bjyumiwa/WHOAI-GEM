<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>WHOAI Gem</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000;color:#fff;
    font-family:system-ui,"Noto Sans JP",sans-serif;touch-action:none;overscroll-behavior:none}

  /* èƒŒæ™¯ */<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>WHOAI Gem</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000;color:#fff;
    font-family:system-ui,"Noto Sans JP",sans-serif;touch-action:none;overscroll-behavior:none}

  /* èƒŒæ™¯ */
  .bg{position:fixed;inset:0;background-size:cover;background-position:center;
      opacity:0;transition:opacity 1s ease-in-out}
  .bg.show{opacity:1}

  /* ã‚­ãƒ£ãƒ© */
  #whoaiWrap{
    position:fixed;
    left:10vw;
    bottom:12vh;
    z-index:5;
    touch-action:none;
    display:none;
    transition:all 3s ease-in-out;
    animation:float 3s ease-in-out infinite;
  }
  
  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-8px); }
  }
  
  #whoai{width:clamp(80px,12vw,140px);user-select:none;filter:drop-shadow(2px 4px 6px rgba(0,0,0,0.3))}
  .bubble{position:absolute;left:50%;bottom:100%;transform:translate(-50%,-8px);
          background:#fff;color:#111;border-radius:15px;padding:8px 12px;font-size:14px;
          box-shadow:0 4px 12px rgba(0,0,0,.3);opacity:0;transition:.3s ease;
          border:2px solid #4cafef;}
  .bubble.show{opacity:1;transform:translate(-50%,-16px)}
  .bubble::after{content:'';position:absolute;top:100%;left:50%;
                 transform:translateX(-50%);border:6px solid transparent;
                 border-top-color:#4cafef}

  /* ãƒã‚±ãƒ„ */
  #bucket{position:fixed;right:2vw;bottom:7vh;z-index:4;width:clamp(74px,14vw,160px);
         filter:drop-shadow(2px 4px 6px rgba(0,0,0,0.3))}
  #bucket img{width:100%;display:block}
  #counter{position:absolute;left:50%;top:45%;transform:translate(-50%,-50%);
           background:#4cafef;color:#fff;border-radius:20px;padding:6px 12px;font-weight:700;
           box-shadow:0 2px 8px rgba(0,0,0,0.3);min-width:30px;text-align:center}

  /* ç ‚ã‚­ãƒ£ãƒ³ãƒã‚¹ */
  #sand{position:fixed;inset:0;z-index:2;touch-action:none;cursor:crosshair}

  /* è² */
  .shell{position:fixed;z-index:3;width:clamp(48px,6vw,72px);height:clamp(48px,6vw,72px);
         transform:translate(-50%,-50%);
         background-size:contain;background-repeat:no-repeat;background-position:center;
         cursor:grab;opacity:0;transition:all .3s ease;
         filter:drop-shadow(1px 2px 4px rgba(0,0,0,0.4))}
  .shell.show{opacity:1;animation:shellGlow 2s ease-in-out infinite}
  .shell.drag{transform:translate(-50%,-50%) scale(1.1);cursor:grabbing;z-index:6}

  @keyframes shellGlow {
    0%, 100% { filter:drop-shadow(1px 2px 4px rgba(0,0,0,0.4)); }
    50% { filter:drop-shadow(1px 2px 8px rgba(255,215,0,0.6)); }
  }

  /* UI */
  #toast{position:fixed;right:15px;top:15px;z-index:10;
         background:rgba(255,255,255,.95);color:#111;
         padding:12px 16px;border-radius:15px;font-size:15px;min-width:200px;
         box-shadow:0 4px 12px rgba(0,0,0,0.2);border-left:4px solid #4cafef;
         transition:transform 0.3s ease}
  
  .ui{position:fixed;left:50%;bottom:15px;transform:translateX(-50%);
      display:flex;gap:10px;z-index:10}
  .ui button{padding:10px 16px;border:none;border-radius:12px;cursor:pointer;
             background:#4cafef;color:#fff;font-weight:600;
             transition:all 0.2s ease;box-shadow:0 2px 6px rgba(0,0,0,0.2)}
  .ui button:hover{background:#3a9bd1;transform:translateY(-2px)}
  .ui button:active{transform:translateY(0px)}

  /* ã‚­ãƒ£ãƒ©é¸æŠ */
  .panel{position:fixed;inset:0;z-index:12;background:rgba(0,0,0,.7);display:none;
         align-items:center;justify-content:center;backdrop-filter:blur(5px)}
  .panel.show{display:flex}
  .card{background:#fff;color:#111;border-radius:20px;padding:20px;width:min(92svw,680px);
        box-shadow:0 8px 24px rgba(0,0,0,0.3)}
  .card h2{text-align:center;color:#4cafef;margin-bottom:20px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:15px}
  .choice{border:2px solid #eee;border-radius:15px;padding:12px;text-align:center;cursor:pointer;
          transition:all .2s ease;background:#f9f9f9}
  .choice:hover{transform:translateY(-3px);border-color:#4cafef;box-shadow:0 4px 12px rgba(76,202,239,0.3)}
  .choice img{max-width:100%;height:auto;display:block;margin:0 auto 8px}
  .choice div{font-size:12px;font-weight:600}

  /* å¤œã®ä¼šè©± */
  #nightPanel .card{width:min(96svw,640px);max-height:90vh;display:flex;flex-direction:column}
  #chatLog{flex:1;background:#f5f5f5;padding:15px;border-radius:15px;overflow:auto;
           max-height:400px;border:1px solid #ddd}
  .msg{margin:8px 0;padding:10px 15px;border-radius:18px;max-width:75%;word-wrap:break-word}
  .msg.me{background:linear-gradient(135deg,#4cafef,#3a9bd1);color:#fff;margin-left:auto}
  .msg.ai{background:#fff;color:#333;margin-right:auto;border:1px solid #eee}
  #chatCtrl{display:flex;gap:8px;margin-top:12px}
  #chatInput{flex:1;padding:12px;border-radius:15px;border:1px solid #ccc;font-size:14px}
  #chatSend{padding:12px 18px;border:none;border-radius:15px;background:#4cafef;color:#fff;
            cursor:pointer;font-weight:600;transition:background 0.2s ease}
  #chatSend:hover{background:#3a9bd1}

  /* ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼è¡¨ç¤º */
  .accessory{position:absolute;pointer-events:none;z-index:6}
  .accessory.crown{top:-20px;left:50%;transform:translateX(-50%);width:30px;height:30px;
                   background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ffd700"><path d="M12 1L15 9L23 7L17 15H7L1 7L9 9L12 1Z"/></svg>');
                   background-size:contain}

  /* ã‚¹ã‚³ã‚¢è¡¨ç¤º */
  #scoreDisplay{position:fixed;left:15px;top:15px;z-index:10;
                background:rgba(255,255,255,0.9);color:#111;padding:10px 15px;
                border-radius:15px;font-weight:600;border-left:4px solid #ffd700}

  /* é·ç§»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  .scene-transition{opacity:0;transition:opacity 2s ease-in-out}
  .scene-transition.active{opacity:1}
</style>
</head>
<body>
  <!-- èƒŒæ™¯ -->
  <div id="bg-sunrise" class="bg show" style="background:linear-gradient(135deg,#ff9a8b,#fecfef,#fecfef)"></div>
  <div id="bg-beach" class="bg" style="background:linear-gradient(to bottom,#87ceeb,#f0e68c 60%,#daa520)"></div>
  <div id="bg-night" class="bg" style="background:linear-gradient(to bottom,#191970,#000080,#00008b)"></div>

  <!-- ã‚­ãƒ£ãƒ© -->
  <div id="whoaiWrap">
    <img id="whoai" src="" alt="whoai">
    <div id="bubble" class="bubble"></div>
    <div class="accessory crown" style="display:none"></div>
  </div>

  <!-- ãƒã‚±ãƒ„ -->
  <div id="bucket">
    <div style="width:100%;height:100%;background:linear-gradient(to bottom,#8b4513,#a0522d);border-radius:50% 50% 40% 40%;position:relative">
      <div style="position:absolute;top:10%;left:15%;right:15%;height:15%;background:#654321;border-radius:50%"></div>
    </div>
    <div id="counter">0</div>
  </div>

  <!-- ã‚¹ã‚³ã‚¢è¡¨ç¤º -->
  <div id="scoreDisplay">è²: <span id="shellCount">0</span> | ãƒ¬ã‚¢: <span id="rareCount">0</span></div>

  <!-- ç ‚ -->
  <canvas id="sand"></canvas>

  <!-- æŒ‡ç¤ºãƒˆãƒ¼ã‚¹ãƒˆ -->
  <div id="toast">ğŸŒ… ãŠã¯ã‚ˆã†ã€‚æœæ—¥ãŒãã‚Œã„ã ã­</div>

  <!-- ä¸»è¦ãƒœã‚¿ãƒ³ -->
  <div class="ui">
    <button id="btnStart">ğŸ® ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    <button id="btnAbout">ğŸ“– ç ”ç©¶ã«ã¤ã„ã¦</button>
    <button id="btnContinue">â–¶ï¸ ç¶šãã‹ã‚‰</button>
    <button id="btnLang">ğŸŒ å¤šè¨€èª</button>
    <button id="btnBegin">ğŸ–ï¸ ã¯ã˜ã‚ã‚‹</button>
    <button id="btnNight">ğŸŒ™ å¤œã¸</button>
    <button id="btnReset">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <!-- ã‚­ãƒ£ãƒ©é¸æŠ -->
  <div id="charPanel" class="panel">
    <div class="card">
      <h2>âœ¨ ã‚­ãƒ£ãƒ©ã‚’é¸ã‚“ã§ã­ âœ¨</h2>
      <div id="charGrid" class="grid"></div>
      <div style="text-align:center;margin-top:15px">
        <button onclick="closeCharPanel()" style="padding:8px 16px;border:1px solid #ccc;border-radius:10px;background:#f9f9f9;cursor:pointer">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- å¤œã®ä¼šè©± -->
  <div id="nightPanel" class="panel">
    <div class="card">
      <h2>ğŸŒ™ ã¾ãŸæ˜æ—¥</h2>
      <div id="chatLog"></div>
      <div id="chatCtrl">
        <input id="chatInput" type="text" placeholder="ğŸŒŠ å¤œç©ºã‚’è¦‹ãªãŒã‚‰ã€ä½•ã‚’è©±ãã†ï¼Ÿ">
        <button id="chatSend">é€ä¿¡</button>
      </div>
      <div style="text-align:center;margin-top:12px">
        <button onclick="closeNight()" style="padding:8px 16px;border:1px solid #ccc;border-radius:10px;background:#f9f9f9;cursor:pointer">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

<script>
/* ========== WHOAI API Simulation ========== */
const WHOAI_TALK = {
  talk: async (message, options) => {
    // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    const responses = [
      "ä»Šæ—¥ã¯æ¥½ã—ã‹ã£ãŸã­ï¼",
      "ãŸãã•ã‚“è²ãŒè¦‹ã¤ã‹ã£ã¦å¬‰ã—ã„ã‚ˆ",
      "å¤œã®æµ·ã¯ç¥ç§˜çš„ã ã­",
      "æ˜æ—¥ã¯ã‚‚ã£ã¨æ¢ç´¢ã—ã‚ˆã†ï¼",
      "å›ã¨ä¸€ç·’ã ã¨æ¥½ã—ã„ã‚ˆ"
    ];
    await new Promise(resolve => setTimeout(resolve, 1000));
    return { reply: responses[Math.floor(Math.random() * responses.length)] };
  }
};

/* ========== å…±é€šUI ========== */
const toast = document.getElementById('toast');
const say = (s) => { 
  toast.innerHTML = s;
  toast.style.transform = 'translateX(10px)';
  setTimeout(() => toast.style.transform = 'translateX(0)', 100);
};

const bg = {
  sunrise: document.getElementById('bg-sunrise'),
  beach: document.getElementById('bg-beach'),
  night: document.getElementById('bg-night'),
};

let currentScene = 'sunrise';
function scene(name) {
  Object.values(bg).forEach(e => e.classList.remove('show'));
  setTimeout(() => {
    bg[name].classList.add('show');
    currentScene = name;
  }, 300);
}

/* ========== ã‚­ãƒ£ãƒ©é–¢é€£ ========== */
const whoaiWrap = document.getElementById('whoaiWrap');
const whoai = document.getElementById('whoai');
const bubble = document.getElementById('bubble');

function showBubble(text) {
  bubble.innerHTML = text;
  bubble.classList.add('show');
  setTimeout(() => bubble.classList.remove('show'), 2000);
}

/* ã‚­ãƒ£ãƒ©é¸æŠ */
const CHAR_LIST = [
  'blue_closed.png', 'green_open.png', 'orange_closed.png', 
  'pink_closed.png', 'purple_closed.png',
  'tane_green.png', 'tane_pink.png', 'tane_purple.png', 'tane_blue.png'
].map(n => `./assets/stage1/${n}`);

const charPanel = document.getElementById('charPanel');
const charGrid = document.getElementById('charGrid');

function openCharPanel() {
  if (!charGrid.dataset.ready) {
    CHAR_LIST.forEach(src => {
      const div = document.createElement('div');
      div.className = 'choice';
      const charName = src.split('/').pop().replace('.png', '').replace('_', ' ');
      div.innerHTML = `<img src="${src}" alt=""><div>${charName}</div>`;
      div.onclick = () => {
        whoai.src = src;
        whoaiWrap.style.display = 'block';
        whoaiWrap.style.left = '10vw';
        whoaiWrap.style.bottom = '12vh';
        closeCharPanel();
        showBubble('ğŸŒŠ ãŠã¯ã‚ˆã†ï¼ä¸€ç·’ã«è²ã‚’æ¢ãã†ï¼');
        say('ğŸ¯ ã‚­ãƒ£ãƒ©ã‚’é¸ã‚“ã ã‚ˆã€‚ğŸ–ï¸ ã¯ã˜ã‚ã‚‹ â†’ æ½®å¹²ç‹©ã‚Šã‚¹ã‚¿ãƒ¼ãƒˆï¼');
      };
      charGrid.appendChild(div);
    });
    charGrid.dataset.ready = '1';
  }
  charPanel.classList.add('show');
}

function closeCharPanel() { charPanel.classList.remove('show'); }

/* ã‚­ãƒ£ãƒ©ã®ãµã‚ãµã‚ç§»å‹• */
function wander() {
  const moveInterval = setInterval(() => {
    if (currentScene !== 'beach') return;
    
    const newLeft = 8 + Math.random() * 70;
    const newBottom = 10 + Math.random() * 50;
    
    whoaiWrap.style.left = newLeft + 'vw';
    whoaiWrap.style.bottom = newBottom + 'vh';
    
    const messages = ['ğŸ” ã“ã“ã‹ãªï¼Ÿ', 'âœ¨ ãã‚Œã„ãªç ‚ã ã­', 'ğŸš è²ã¯ã©ã“ã ã‚ã†ï¼Ÿ', 'ğŸŒŠ æ³¢ã®éŸ³ãŒå¿ƒåœ°ã„ã„'];
    if (Math.random() < 0.3) {
      showBubble(messages[Math.floor(Math.random() * messages.length)]);
    }
  }, 4000);
}

/* ========== ç ‚ã‚­ãƒ£ãƒ³ãƒã‚¹ ========== */
const sand = document.getElementById('sand');
const ctx = sand.getContext('2d', { willReadFrequently: true });

function resizeSand() {
  sand.width = innerWidth;
  sand.height = innerHeight;

  const g = ctx.createLinearGradient(0, 0, 0, sand.height);
  g.addColorStop(0, '#f0e68c');
  g.addColorStop(0.7, '#daa520');
  g.addColorStop(1, '#b8860b');
  ctx.fillStyle = g;
  ctx.fillRect(0, 0, sand.width, sand.height);

  // ç ‚ã®è³ªæ„Ÿã‚’è¿½åŠ 
  ctx.globalAlpha = 0.15;
  for (let i = 0; i < 1000; i++) {
    const x = Math.random() * sand.width;
    const y = Math.random() * sand.height;
    const size = Math.random() * 2 + 0.5;
    ctx.fillStyle = (i % 4 === 0) ? '#cd853f' : '#daa520';
    ctx.beginPath();
    ctx.arc(x, y, size, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;
}

const BRUSH = 35;
function brushAt(x, y) {
  ctx.globalCompositeOperation = 'destination-out';
  ctx.globalAlpha = 0.4;
  
  // ã‚ˆã‚Šè‡ªç„¶ãªãƒ–ãƒ©ã‚·åŠ¹æœ
  const gradient = ctx.createRadialGradient(x, y, 0, x, y, BRUSH);
  gradient.addColorStop(0, 'rgba(0,0,0,1)');
  gradient.addColorStop(0.7, 'rgba(0,0,0,0.8)');
  gradient.addColorStop(1, 'rgba(0,0,0,0)');
  
  ctx.fillStyle = gradient;
  ctx.beginPath();
  ctx.arc(x, y, BRUSH, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.globalAlpha = 1;
  ctx.globalCompositeOperation = 'source-over';
  
  maybeSpawnNear(x, y);
}

sand.addEventListener('pointerdown', e => {
  if (currentScene !== 'beach') return;
  brushAt(e.clientX, e.clientY);
});

sand.addEventListener('pointermove', e => {
  if (currentScene !== 'beach' || e.buttons === 0) return;
  brushAt(e.clientX, e.clientY);
});

/* ========== è²ã®å‡ºç¾ï¼†ãƒ‰ãƒ©ãƒƒã‚° ========== */
const COMMON = [
  './public/items/asari1.png',
  './public/items/asari2.png', 
  './public/items/asari3.png'
];
const RARE = [
  './public/items/aurora_shell.png',
  './public/items/rare_pearl.png',
  './public/items/rare_rainbow.png'
];

const bucket = document.getElementById('bucket');
const counter = document.getElementById('counter');
const shellCount = document.getElementById('shellCount');
const rareCount = document.getElementById('rareCount');

let count = 0;
let rareCollected = 0;
const shells = [];
const MAX_SHELLS = 12;
const MIN_DIST = 80;
const SPAWN_P = 0.35;

function tooClose(x, y) { 
  return shells.some(s => Math.hypot(s.x - x, s.y - y) < MIN_DIST); 
}

function avoidBucket(x, y) {
  const b = bucket.getBoundingClientRect();
  const cx = (b.left + b.right) / 2;
  const cy = (b.top + b.bottom) / 2;
  return Math.hypot(cx - x, cy - y) < 140;
}

function maybeSpawnNear(x, y) {
  if (shells.length >= MAX_SHELLS) return;
  if (Math.random() > SPAWN_P) return;

  let px = x + (Math.random() * 2 - 1) * 100;
  let py = y + (Math.random() * 2 - 1) * 100;
  px = Math.max(80, Math.min(innerWidth - 80, px));
  py = Math.max(120, Math.min(innerHeight - 120, py));
  
  if (tooClose(px, py) || avoidBucket(px, py)) return;

  const isRare = Math.random() < 0.18;
  const pool = isRare ? RARE : COMMON;
  const src = pool[Math.floor(Math.random() * pool.length)];

  const el = document.createElement('div');
  el.className = 'shell';
  el.style.left = px + 'px';
  el.style.top = py + 'px';
  el.style.backgroundImage = `url(${src})`;
  el.dataset.rare = isRare;
  
  document.body.appendChild(el);
  requestAnimationFrame(() => el.classList.add('show'));
  enableShellDrag(el, src, isRare);
  shells.push({ el, x: px, y: py, rare: isRare });
}

function enableShellDrag(el, src, isRare) {
  let pid = null, dx = 0, dy = 0;

  el.addEventListener('pointerdown', e => {
    e.preventDefault();
    pid = e.pointerId;
    el.setPointerCapture(pid);
    dx = e.clientX - parseFloat(el.style.left);
    dy = e.clientY - parseFloat(el.style.top);
    el.classList.add('drag');
  }, { passive: false });

  el.addEventListener('pointermove', e => {
    if (e.pointerId !== pid) return;
    e.preventDefault();
    el.style.left = (e.clientX - dx) + 'px';
    el.style.top = (e.clientY - dy) + 'px';
  }, { passive: false });

  function finish(e) {
    if (e.pointerId !== pid) return;
    e.preventDefault();
    el.classList.remove('drag');
    el.releasePointerCapture(pid);
    pid = null;

    const b = bucket.getBoundingClientRect();
    const s = el.getBoundingClientRect();
    const hit = !(s.right < b.left || s.left > b.right || s.bottom < b.top || s.top > b.bottom);
    
    if (hit) {
      el.remove();
      const i = shells.findIndex(o => o.el === el);
      if (i > -1) shells.splice(i, 1);
      
      count++;
      if (isRare) {
        rareCollected++;
        showBubble('âœ¨ ã‚ã‚ï¼ãƒ¬ã‚¢è²ã ã‚ˆï¼');
        // ãƒ¬ã‚¢è²5å€‹ã§ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼è£…ç€
        if (rareCollected >= 5) {
          whoaiWrap.querySelector('.crown').style.display = 'block';
          showBubble('ğŸ‘‘ ç‹å† ã‚’ã‚²ãƒƒãƒˆï¼');
        }
      } else {
        const messages = ['ğŸ‰ ã‚„ã£ãŸã­ï¼', 'ğŸ‘ ä¸Šæ‰‹ï¼', 'ğŸ˜Š ãã‚Œã„ï¼'];
        showBubble(messages[Math.floor(Math.random() * messages.length)]);
      }
      
      counter.textContent = count;
      shellCount.textContent = count;
      rareCount.textContent = rareCollected;
    }
  }
  
  el.addEventListener('pointerup', finish, { passive: false });
  el.addEventListener('pointercancel', finish, { passive: false });
}

/* ========== å¤œï¼šãƒãƒ£ãƒƒãƒˆ ========== */
const nightPanel = document.getElementById('nightPanel');
const chatLog = document.getElementById('chatLog');
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');

function openNight() {
  nightPanel.classList.add('show');
  addMsg('ai', 'ğŸŒ™ å¤œç©ºãŒãã‚Œã„ã ã­ã€‚ä»Šæ—¥ã¯ã©ã‚“ãªä¸€æ—¥ã ã£ãŸï¼Ÿ');
}

function closeNight() { nightPanel.classList.remove('show'); }

function addMsg(role, text) {
  const div = document.createElement('div');
  div.className = 'msg ' + (role === 'user' ? 'me' : 'ai');
  div.textContent = text;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
}

chatSend.onclick = async () => {
  const text = chatInput.value.trim();
  if (!text) return;
  addMsg('user', text);
  chatInput.value = '';

  try {
    const { reply } = await WHOAI_TALK.talk(text, { state: { totalCollected: count } });
    addMsg('ai', reply || 'â€¦');
  } catch (e) {
    addMsg('ai', 'ï¼ˆæ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰');
    console.error(e);
  }
};

chatInput.addEventListener('keypress', e => {
  if (e.key === 'Enter') chatSend.onclick();
});

/* ========== ãƒœã‚¿ãƒ³ã¨ã‚·ãƒ¼ãƒ³é·ç§» ========== */
document.getElementById('btnStart').onclick = () => {
  openCharPanel();
  say('âœ¨ ã‚­ãƒ£ãƒ©ã‚’é¸ã‚“ã§ã­');
};

document.getElementById('btnAbout').onclick = () => {
  say('ğŸ”¬ ã“ã®ã‚²ãƒ¼ãƒ ã¯æ½®å¹²ç‹©ã‚Šä½“é¨“ã‚’é€šã—ã¦è‡ªç„¶ã¨ã®è§¦ã‚Œåˆã„ã‚’ç ”ç©¶ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™');
};

document.getElementById('btnContinue').onclick = () => {
  say('ğŸ“± ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™');
};

document.getElementById('btnLang').onclick = () => {
  say('ğŸŒ å¤šè¨€èªå¯¾å¿œã¯æº–å‚™ä¸­ã§ã™');
};

document.getElementById('btnBegin').onclick = () => {
  scene('beach');
  say('ğŸ–ï¸ ã§ã¯ã€æ½®å¹²ç‹©ã‚Šã‚’å§‹ã‚ã‚ˆã†ï¼');
  
  setTimeout(() => {
    resizeSand();
    say('ğŸ” ç ‚ã®ä¸­ã«è²ãŒã‚ã‚‹ã‚ˆã€‚æŒ‡ã§ãªã§ã¦æ¢ã—ã¦ã­');
    
    if (whoaiWrap.style.display !== 'block') {
      whoai.src = './assets/stage1/green_open.png';
      whoaiWrap.style.display = 'block';
      whoaiWrap.style.left = '10vw';
      whoaiWrap.style.bottom = '12vh';
    }
    wander();
  }, 2000);
};

document.getElementById('btnNight').onclick = () => {
  scene('night');
  say('ğŸŒ™ å¤œã®æµ·ã€‚è©±ãã†ã‹ï¼Ÿ');
  openNight();
};

document.getElementById('btnReset').onclick = () => {
  count = 0;
  rareCollected = 0;
  counter.textContent = '0';
  shellCount.textContent = '0';
  rareCount.textContent = '0';
  whoaiWrap.querySelector('.crown').style.display = 'none';
  
  document.querySelectorAll('.shell').forEach(e => e.remove());
  shells.length = 0;
  resizeSand();
  say('ğŸ”„ ãƒªã‚»ãƒƒãƒˆã—ãŸã‚ˆ');
};

/* ========== åˆæœŸåŒ– ========== */
function init() {
  scene('sunrise');
  say('ğŸŒ… ãŠã¯ã‚ˆã†ã€‚æœæ—¥ãŒãã‚Œã„ã ã­');
  resizeSand();
}

addEventListener('resize', resizeSand);
init();
</script>
</body>
</html>
  .bg{position:fixed;inset:0;background-size:cover;background-position:center;
      opacity:0;transition:opacity .7s}
  .bg.show{opacity:1}

  /* ã‚­ãƒ£ãƒ© */
  #whoaiWrap{
    position:fixed;
    left:10vw;              /* åˆæœŸä½ç½®ï¼ˆå¿…é ˆï¼‰ */
    bottom:12vh;            /* åˆæœŸä½ç½®ï¼ˆå¿…é ˆï¼‰ */
    z-index:5;
    touch-action:none;
    display:none;
    transition:left 4s ease, bottom 4s ease;
  }
  #whoai{width:clamp(80px,12vw,140px);user-select:none}
  .bubble{position:absolute;left:50%;bottom:100%;transform:translate(-50%,-8px);
          background:#fff;color:#111;border-radius:10px;padding:4px 8px;font-size:14px;
          box-shadow:0 2px 6px rgba(0,0,0,.25);opacity:0;transition:.18s}
  .bubble.show{opacity:1;transform:translate(-50%,-12px)}

  /* ãƒã‚±ãƒ„ */
  #bucket{position:fixed;right:2vw;bottom:7vh;z-index:4;width:clamp(74px,14vw,160px)}
  #bucket img{width:100%;display:block}
  #counter{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
           background:#fff;color:#111;border-radius:999px;padding:4px 8px;font-weight:600}

  /* ç ‚ã‚­ãƒ£ãƒ³ãƒã‚¹ */
  #sand{position:fixed;inset:0;z-index:2;touch-action:none}

  /* è² */
  .shell{position:fixed;z-index:3;width:clamp(48px,6vw,72px);height:clamp(48px,6vw,72px);
         transform:translate(-50%,-50%);
         background-size:contain;background-repeat:no-repeat;background-position:center;
         cursor:grab;opacity:0;transition:opacity .18s, transform .18s}
  .shell.show{opacity:1}
  .shell.drag{transform:translate(-50%,-50%) scale(1.04)}

  /* UI */
  #toast{position:fixed;right:10px;top:10px;z-index:10;
         background:rgba(255,255,255,.92);color:#111;
         padding:8px 12px;border-radius:10px;font-size:14px;min-width:180px}
  .ui{position:fixed;left:50%;bottom:10px;transform:translateX(-50%);
      display:flex;gap:8px;z-index:10}
  .ui button{padding:8px 14px;border:none;border-radius:10px;cursor:pointer}

  /* ã‚­ãƒ£ãƒ©é¸æŠ */
  .panel{position:fixed;inset:0;z-index:12;background:rgba(0,0,0,.55);display:none;
         align-items:center;justify-content:center}
  .panel.show{display:flex}
  .card{background:#fff;color:#111;border-radius:14px;padding:16px;width:min(92svw,680px)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:12px}
  .choice{border:1px solid #eee;border-radius:12px;padding:8px;text-align:center;cursor:pointer;transition:transform .12s}
  .choice:hover{transform:translateY(-2px)}
  .choice img{max-width:100%;height:auto;display:block;margin:0 auto 6px}

  /* å¤œã®ä¼šè©±ï¼ˆLINEé¢¨ï¼‰ */
  #nightPanel .card{width:min(96svw,640px);max-height:90vh;display:flex;flex-direction:column}
  #chatLog{flex:1;background:#f2f2f2;padding:10px;border-radius:10px;overflow:auto}
  .msg{margin:6px 0;padding:8px 12px;border-radius:16px;max-width:70%}
  .msg.me{background:#aee1ff;color:#002; margin-left:auto}
  .msg.ai{background:#fff;color:#000;   margin-right:auto}
  #chatCtrl{display:flex;gap:6px;margin-top:8px}
  #chatInput{flex:1;padding:10px;border-radius:12px;border:1px solid #ccc}
  #chatSend{padding:10px 14px;border:none;border-radius:12px;background:#4cafef;color:#fff;cursor:pointer}
</style>
</head>
<body>
  <!-- èƒŒæ™¯ -->
  <div id="bg-sunrise" class="bg" style="background-image:url('./public/bg/sunrise.jpg')"></div>
  <div id="bg-beach"   class="bg" style="background-image:url('./public/bg/beach_day.jpg')"></div>
  <div id="bg-night"   class="bg" style="background-image:url('./public/bg/night_beach.jpg')"></div>

  <!-- ã‚­ãƒ£ãƒ© -->
  <div id="whoaiWrap">
    <img id="whoai" src="" alt="whoai">
    <div id="bubble" class="bubble"></div>
  </div>

  <!-- ãƒã‚±ãƒ„ -->
  <div id="bucket">
    <img id="bucketImg" src="./public/bucket.png" alt="bucket">
    <div id="counter">0</div>
  </div>

  <!-- ç ‚ -->
  <canvas id="sand"></canvas>

  <!-- æŒ‡ç¤ºãƒˆãƒ¼ã‚¹ãƒˆï¼ˆå³ä¸Šï¼‰ -->
  <div id="toast">ãŠã¯ã‚ˆã†ã€‚æœæ—¥ãŒãã‚Œã„ã ã­</div>

  <!-- ä¸»è¦ãƒœã‚¿ãƒ³ -->
  <div class="ui">
    <button id="btnStart">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    <button id="btnBegin">ã¯ã˜ã‚ã«</button>
    <button id="btnNight">å¤œã¸</button>
    <button id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <!-- ã‚­ãƒ£ãƒ©é¸æŠ -->
  <div id="charPanel" class="panel">
    <div class="card">
      <h2>ã‚­ãƒ£ãƒ©ã‚’é¸ã‚“ã§ã­</h2>
      <div id="charGrid" class="grid"></div>
      <div style="text-align:right;margin-top:8px">
        <button onclick="closeCharPanel()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- å¤œã®ä¼šè©± -->
  <div id="nightPanel" class="panel">
    <div class="card">
      <h2>ã¾ãŸæ˜æ—¥</h2>
      <div id="chatLog"></div>
      <div id="chatCtrl">
        <input id="chatInput" type="text" placeholder="å¤œç©ºã‚’è¦‹ãªãŒã‚‰ã€ä½•ã‚’è©±ãã†ï¼Ÿ">
        <button id="chatSend">é€ä¿¡</button>
      </div>
      <div style="text-align:right;margin-top:8px">
        <button onclick="closeNight()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

<!-- WHOAIã®ä¼šè©±APIãƒ©ãƒƒãƒ‘ -->
<script src="./api/talk.js"></script>
<script>
/* ========== å…±é€šUI ========== */
const toast = document.getElementById('toast');
const say = (s)=>{ toast.textContent = s; };

const bg = {
  sunrise: document.getElementById('bg-sunrise'),
  beach  : document.getElementById('bg-beach'),
  night  : document.getElementById('bg-night'),
};
let currentScene = 'sunrise';
function scene(name){
  Object.values(bg).forEach(e=>e.classList.remove('show'));
  bg[name].classList.add('show');
  currentScene = name;
}

/* ========== ã‚­ãƒ£ãƒ©é–¢é€£ ========== */
const whoaiWrap = document.getElementById('whoaiWrap');
const whoai     = document.getElementById('whoai');
const bubble    = document.getElementById('bubble');

function showBubble(text){
  bubble.textContent = text;
  bubble.classList.add('show');
  setTimeout(()=>bubble.classList.remove('show'), 1200);
}

/* ã‚­ãƒ£ãƒ©é¸æŠ */
const CHAR_LIST = [
  'blue_closed.png','green_open.png','orange_closed.png','pink_closed.png','purple_closed.png',
  'tane_green.png','tane_pink.png','tane_purple.png','tane_blue.png'
].map(n=>`./assets/stage1/${n}`);

const charPanel = document.getElementById('charPanel');
const charGrid  = document.getElementById('charGrid');

function openCharPanel(){
  if(!charGrid.dataset.ready){
    CHAR_LIST.forEach(src=>{
      const div = document.createElement('div');
      div.className = 'choice';
      div.innerHTML = `<img src="${src}" alt=""><div>${src.split('/').pop().replace('.png','')}</div>`;
      div.onclick = ()=>{
        whoai.src = src;

        // ã“ã“ãŒé‡è¦ï¼šç¢ºå®Ÿã«ç”»é¢å†…ã«å‡ºã™ï¼ˆä½ç½®ã‚’æ˜ç¤ºï¼†è¡¨ç¤ºï¼‰
        whoaiWrap.style.display = 'block';
        whoaiWrap.style.left    = '10vw';
        whoaiWrap.style.bottom  = '12vh';
        whoaiWrap.style.top     = 'auto';

        closeCharPanel();
        showBubble('ãŠã¯ã‚ˆã†ï¼');
        say('ã‚­ãƒ£ãƒ©ã‚’é¸ã‚“ã ã‚ˆã€‚ã¯ã˜ã‚ã« â†’ ç ‚ã‚’ã‚ˆã‘ã¦ã¿ã‚ˆã†');
      };
      charGrid.appendChild(div);
    });
    charGrid.dataset.ready = '1';
  }
  charPanel.classList.add('show');
}
function closeCharPanel(){ charPanel.classList.remove('show'); }

/* ç©ã‚„ã‹ã«ãƒ©ãƒ³ãƒ€ãƒ ç§»å‹•ï¼ˆç ‚æ¢ã—ã£ã½ãï¼‰ */
function wander(){
  setInterval(()=>{
    // ç”»é¢ã® 8ã€œ80vwã€10ã€œ70vh ã‚’ãƒ©ãƒ³ãƒ€ãƒ ç§»å‹•
    whoaiWrap.style.left   = (8 + Math.random()*72) + 'vw';
    whoaiWrap.style.bottom = (10 + Math.random()*60) + 'vh';
  }, 5000);
}

/* ========== ç ‚ã‚­ãƒ£ãƒ³ãƒã‚¹ ========== */
const sand = document.getElementById('sand');
const ctx  = sand.getContext('2d', { willReadFrequently:true });

function resizeSand(){
  sand.width = innerWidth; sand.height = innerHeight;

  // ç ‚ã®ãƒ™ãƒ¼ã‚¹ï¼ˆã‚°ãƒ©ãƒ‡ï¼‹ãƒã‚¤ã‚ºã£ã½ã„æ–‘ï¼‰
  const g = ctx.createLinearGradient(0,0,0,sand.height);
  g.addColorStop(0, '#e7d9b7');
  g.addColorStop(1, '#c8b68f');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,sand.width,sand.height);

  // ç ‚ç²’ã£ã½ã„æ¨¡æ§˜ã‚’è»½ã
  ctx.globalAlpha = 0.12;
  for(let i=0;i<800;i++){
    const x = Math.random()*sand.width;
    const y = Math.random()*sand.height;
    ctx.fillStyle = (i%3===0)?'#bfae82':'#d2c29a';
    ctx.beginPath(); ctx.arc(x,y,Math.random()*1.2+0.2,0,Math.PI*2); ctx.fill();
  }
  ctx.globalAlpha = 1;
}

const BRUSH = 30;
function brushAt(x,y){
  // destination-out ã§ã€Œå‰Šã‚‹ã€è¡¨ç¾ã€‚ã‚¢ãƒ«ãƒ•ã‚¡ã‚’å¼±ã‚ã¦è‡ªç„¶ã«
  ctx.globalCompositeOperation = 'destination-out';
  ctx.globalAlpha = 0.35;
  ctx.beginPath(); ctx.arc(x,y,BRUSH,0,Math.PI*2); ctx.fill();
  ctx.globalAlpha = 1;
  ctx.globalCompositeOperation = 'source-over';

  // å‰Šã£ãŸåœ°ç‚¹ã®è¿‘ãã«ç¢ºç‡ã§å‡ºç¾
  maybeSpawnNear(x,y);
}

sand.addEventListener('pointerdown', e=>{
  if(currentScene!=='beach') return;
  brushAt(e.clientX, e.clientY);
});
sand.addEventListener('pointermove', e=>{
  if(currentScene!=='beach' || e.buttons===0) return;
  brushAt(e.clientX, e.clientY);
});

/* ========== è²ã®å‡ºç¾ï¼†ãƒ‰ãƒ©ãƒƒã‚° ========== */
const COMMON = [
  './public/items/asari1.png','./public/items/asari2.png','./public/items/asari3.png'
];
const RARE = [
  './public/items/aurora_shell.png','./public/items/rare_pearl.png','./public/items/rare_rainbow.png'
];

const bucket  = document.getElementById('bucket');
const counter = document.getElementById('counter');
let count = 0;

const shells = [];
const MAX_SHELLS = 10;
const MIN_DIST   = 90;
const SPAWN_P    = 0.28;

function tooClose(x,y){ return shells.some(s=>Math.hypot(s.x-x,s.y-y)<MIN_DIST); }
function avoidBucket(x,y){
  const b=bucket.getBoundingClientRect();
  const cx=(b.left+b.right)/2, cy=(b.top+b.bottom)/2;
  return Math.hypot(cx-x,cy-y)<120;
}

function maybeSpawnNear(x,y){
  if(shells.length>=MAX_SHELLS) return;
  if(Math.random()>SPAWN_P) return;

  // ç ‚ã®ä¸­ã«æ•£ã‚‰ã°ã‚‹ã‚ˆã†ã€å°‘ã—ãšã‚‰ã™
  let px = x + (Math.random()*2-1)*90;
  let py = y + (Math.random()*2-1)*90;
  px = Math.max(60, Math.min(innerWidth -60, px));
  py = Math.max(100, Math.min(innerHeight-100, py));
  if(tooClose(px,py) || avoidBucket(px,py)) return;

  const pool = Math.random()<0.82 ? COMMON : RARE;
  const src  = pool[Math.floor(Math.random()*pool.length)];

  const el = document.createElement('div');
  el.className = 'shell';
  el.style.left = px + 'px';
  el.style.top  = py + 'px';
  el.style.backgroundImage = `url(${src})`;
  document.body.appendChild(el);
  requestAnimationFrame(()=>el.classList.add('show'));
  enableShellDrag(el, src);
  shells.push({el,x:px,y:py});
}

function enableShellDrag(el, src){
  let pid=null, dx=0, dy=0;

  el.addEventListener('pointerdown', e=>{
    e.preventDefault();
    pid = e.pointerId;
    el.setPointerCapture(pid);
    dx = e.clientX - parseFloat(el.style.left);
    dy = e.clientY - parseFloat(el.style.top);
    el.classList.add('drag');
  }, {passive:false});

  el.addEventListener('pointermove', e=>{
    if(e.pointerId!==pid) return;
    e.preventDefault();
    el.style.left = (e.clientX - dx) + 'px';
    el.style.top  = (e.clientY - dy) + 'px';
  }, {passive:false});

  function finish(e){
    if(e.pointerId!==pid) return;
    e.preventDefault();
    el.classList.remove('drag');
    el.releasePointerCapture(pid);
    pid=null;

    const b=bucket.getBoundingClientRect();
    const s=el.getBoundingClientRect();
    const hit = !(s.right<b.left || s.left>b.right || s.bottom<b.top || s.top>b.bottom);
    if(hit){
      el.remove();
      const i=shells.findIndex(o=>o.el===el); if(i>-1) shells.splice(i,1);
      counter.textContent = ++count;
      showBubble( Math.random()<0.2 ? 'ãƒ¬ã‚¢ã ã‚ˆï¼' : 'ã‚„ã£ãŸã­ï¼' );
    }
  }
  el.addEventListener('pointerup', finish,   {passive:false});
  el.addEventListener('pointercancel', finish,{passive:false});
}

/* ========== å¤œï¼šLINEé¢¨ãƒãƒ£ãƒƒãƒˆï¼ˆapi/talk.jsä½¿ç”¨ï¼‰ ========== */
const nightPanel = document.getElementById('nightPanel');
const chatLog    = document.getElementById('chatLog');
const chatInput  = document.getElementById('chatInput');
const chatSend   = document.getElementById('chatSend');

function openNight(){
  nightPanel.classList.add('show');
  addMsg('ai','å¤œç©ºãŒãã‚Œã„ã ã­ã€‚ä»Šæ—¥ã¯ã©ã‚“ãªä¸€æ—¥ã ã£ãŸï¼Ÿ');
}
function closeNight(){ nightPanel.classList.remove('show'); }
function addMsg(role,text){
  const div=document.createElement('div');
  div.className='msg '+(role==='user'?'me':'ai');
  div.textContent=text;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
}
chatSend.onclick = async ()=>{
  const text = chatInput.value.trim(); if(!text) return;
  addMsg('user', text); chatInput.value='';

  try{
    const { reply } = await WHOAI_TALK.talk(text, { state:{ totalCollected:count } });
    addMsg('ai', reply || 'â€¦');
  }catch(e){
    addMsg('ai','ï¼ˆæ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰');
    console.error(e);
  }
};

/* ========== ãƒœã‚¿ãƒ³ã¨ã‚·ãƒ¼ãƒ³é·ç§» ========== */
document.getElementById('btnStart').onclick = ()=>{
  openCharPanel();
  say('ã‚­ãƒ£ãƒ©ã‚’é¸ã‚“ã§ã­');
};
document.getElementById('btnBegin').onclick = ()=>{
  scene('beach');
  say('ç ‚ã®ä¸­ã«è²ãŒã‚ã‚‹ã‚ˆã€‚ãªã§ã¦æ¢ã—ã¦ã­');
  resizeSand();
  // ã‚­ãƒ£ãƒ©ãŒç”»é¢å†…ã§ã‚†ã£ãã‚Šå‹•ãï¼ˆæ¢ç´¢ã—ã¦ã„ã‚‹é›°å›²æ°—ï¼‰
  if(whoaiWrap.style.display!=='block'){
    // ã¾ã é¸ã°ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ä»®ã«ç·‘ã‚’å‡ºã™
    whoai.src = './assets/stage1/green_open.png';
    whoaiWrap.style.display='block';
    whoaiWrap.style.left='10vw';
    whoaiWrap.style.bottom='12vh';
  }
  wander();
};
document.getElementById('btnNight').onclick = ()=>{
  scene('night');
  say('å¤œã®æµ·ã€‚è©±ãã†ã‹ï¼Ÿ');
  openNight();
};
document.getElementById('btnReset').onclick = ()=>{
  // ã‚·ãƒ³ãƒ—ãƒ«ãªåˆæœŸåŒ–
  count = 0; counter.textContent = 0;
  document.querySelectorAll('.shell').forEach(e=>e.remove());
  resizeSand();
  say('ãƒªã‚»ãƒƒãƒˆã—ãŸã‚ˆ');
};

/* ========== åˆæœŸåŒ– ========== */
function init(){
  scene('sunrise');
  say('ãŠã¯ã‚ˆã†ã€‚æœæ—¥ãŒãã‚Œã„ã ã­');
  resizeSand();
}
addEventListener('resize', resizeSand);
init();
</script>
</body>
</html>

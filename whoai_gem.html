<!DOCTYPE html>
<html lang="ja" data-lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>WHOAI Gem</title>
  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#000;color:#fff;font-family:system-ui,"Noto Sans JP",sans-serif;touch-action:none;overscroll-behavior:none}
    .bg{position:fixed;inset:0;background-size:cover;background-position:center;opacity:0;transition:opacity .7s}
    .bg.show{opacity:1}

    /* Topbar */
    #topbar{position:fixed;left:0;right:0;top:0;z-index:40;display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,0))}
    #topbar .left,#topbar .right{display:flex;gap:8px}
    #topbar button{padding:6px 10px;border:none;border-radius:10px;background:rgba(255,255,255,.92);color:#111;cursor:pointer}

    /* Hero（朝日画面：キャラ/バケツは非表示） */
    #hero{position:fixed;inset:0;z-index:30;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;text-align:center;background:rgba(0,0,0,.15)}
    #hero h1{font-size:clamp(20px,4vw,36px);margin:0 16px;text-shadow:0 2px 8px rgba(0,0,0,.45)}
    .heroBtns{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
    .heroBtns button{padding:12px 18px;border:none;border-radius:12px;cursor:pointer;font-weight:700}

    /* キャラ */
    #whoaiWrap{position:fixed;left:10vw;bottom:12vh;z-index:5;touch-action:none;display:none;transition:left 4s ease, bottom 4s ease}
    #whoai{width:clamp(80px,12vw,140px);user-select:none;display:block}
    #accLayer{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}
    .bubble{position:absolute;left:50%;bottom:100%;transform:translate(-50%,-8px);background:rgba(255,255,255,.78);backdrop-filter:blur(2px);color:#111;border-radius:10px;padding:4px 8px;font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,.25);opacity:0;transition:.18s;white-space:nowrap}
    .bubble.show{opacity:1;transform:translate(-50%,-12px)}

    /* アクセサリー（基準サイズ＆配置） */
    .acc{position:absolute;left:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:2}
    .acc.knit_hat{       top:24%; width:52%;}
    .acc.straw_hat{     top:20%; width:55%;}
    .acc.sunglasses{    top:48%; width:50%;}
    .acc.ribbon_yellow{ top:26%; left:60%; width:32%;}
    .acc.star_yellow{   top:30%; left:65%; width:30%;}

    /* バケツ（ビーチのみ表示） */
    #bucket{position:fixed;right:2vw;bottom:7vh;z-index:4;width:clamp(74px,14vw,160px);display:none}
    #bucket.show{display:block}
    #bucket img{width:100%;display:block}
    #counter{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.9);color:#111;border-radius:999px;padding:4px 8px;font-weight:600}

    /* 砂（ビーチのみ） */
    #sand{position:fixed;inset:0;z-index:2;touch-action:none;display:none}
    #sand.show{display:block}

    /* 貝 */
    .shell{position:fixed;z-index:3;width:clamp(48px,6vw,72px);height:clamp(48px,6vw,72px);transform:translate(-50%,-50%);background-size:contain;background-repeat:no-repeat;background-position:center;cursor:grab;opacity:0;transition:opacity .18s, transform .18s}
    .shell.show{opacity:1}
    .shell.drag{transform:translate(-50%,-50%) scale(1.04)}

    /* トースト / フッターUI */
    #toast{position:fixed;right:10px;top:42px;z-index:20;background:rgba(255,255,255,.92);color:#111;padding:8px 12px;border-radius:10px;font-size:14px;min-width:180px}
    .ui{position:fixed;left:50%;bottom:10px;transform:translateX(-50%);display:none;gap:8px;z-index:10;flex-wrap:wrap;justify-content:center}
    .ui.show{display:flex}
    .ui button{padding:8px 14px;border:none;border-radius:10px;cursor:pointer}

    /* パネル（最前面） */
    .panel{position:fixed;inset:0;z-index:90;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center}
    .panel.show{display:flex}
    .card{background:#fff;color:#111;border-radius:14px;padding:16px;width:min(92svw,720px)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:12px}
    .choice{border:1px solid #eee;border-radius:12px;padding:8px;text-align:center;cursor:pointer;transition:transform .12s}
    .choice:hover{transform:translateY(-2px)}
    .choice img{width:80px;height:auto;display:block;margin:0 auto 6px}

    /* アクセサリー一覧のロック表示 */
    .accChoice.locked{opacity:.45;filter:grayscale(1)}
    .meta{font-size:12px;color:#666;text-align:center}

    /* 夜の会話（半透明） */
    #nightPanel .card{width:min(96svw,640px);max-height:90vh;display:flex;flex-direction:column;backdrop-filter:blur(2px)}
    #chatLog{flex:1;background:rgba(242,242,242,.75);padding:10px;border-radius:10px;overflow:auto}
    .msg{margin:6px 0;padding:8px 12px;border-radius:16px;max-width:70%}
    .msg.me{background:rgba(174,225,255,.85);color:#002;margin-left:auto}
    .msg.ai{background:rgba(255,255,255,.85);color:#000;margin-right:auto}
    #chatCtrl{display:flex;gap:6px;margin-top:8px}
    #chatInput{flex:1;padding:10px;border-radius:12px;border:1px solid #ccc}
    #chatSend{padding:10px 14px;border:none;border-radius:12px;background:#4cafef;color:#fff;cursor:pointer}
  </style>
</head>
<body>
  <!-- 背景 -->
  <div id="bg-sunrise" class="bg show" style="background-image:url('./public/bg/sunrise.jpg')"></div>
  <div id="bg-beach"   class="bg"        style="background-image:url('./public/bg/beach_day.jpg')"></div>
  <div id="bg-night"   class="bg"        style="background-image:url('./public/bg/night_beach.jpg')"></div>

  <!-- Topbar -->
  <div id="topbar">
    <div class="left"><button id="btnAbout">研究について</button></div>
    <div class="right"><button id="btnLang">EN</button></div>
  </div>

  <!-- Hero（最初の画面） -->
  <div id="hero">
    <h1 id="heroTitle">朝日の海へようこそ</h1>
    <div class="heroBtns">
      <button id="btnHeroStart">スタート</button>
      <button id="btnHeroContinue">続きから</button>
    </div>
  </div>

  <!-- キャラ -->
  <div id="whoaiWrap">
    <img id="whoai" src="" alt="whoai">
    <div id="accLayer"></div>
    <div id="bubble" class="bubble"></div>
  </div>

  <!-- バケツ（ビーチのみ） -->
  <div id="bucket">
    <img id="bucketImg" src="./public/bucket.png" alt="bucket">
    <div id="counter">0</div>
  </div>

  <!-- 砂（ビーチのみ） -->
  <canvas id="sand"></canvas>

  <!-- トースト / フッターUI -->
  <div id="toast">朝日がきれいだね</div>
  <div class="ui" id="gameUi">
    <button id="btnNight">夜へ</button>
    <button id="btnAccessory">アクセサリー</button>
    <button id="btnCollection">コレクション</button>
    <button id="btnReset">リセット</button>
  </div>

  <!-- パネル：キャラ選択 -->
  <div id="charPanel" class="panel" aria-hidden="true">
    <div class="card">
      <h2 id="charTitle">キャラを選んでね</h2>
      <div id="charGrid" class="grid"></div>
      <div style="text-align:right;margin-top:8px"><button id="charClose">閉じる</button></div>
    </div>
  </div>

  <!-- パネル：夜の会話 -->
  <div id="nightPanel" class="panel" aria-hidden="true">
    <div class="card">
      <h2 id="nightTitle">また明日</h2>
      <div id="chatLog"></div>
      <div id="chatCtrl">
        <input id="chatInput" type="text" placeholder="夜空を見ながら、何を話そう？">
        <button id="chatSend">送信</button>
      </div>
      <div style="text-align:right;margin-top:8px"><button id="nightClose">閉じる</button></div>
    </div>
  </div>

  <!-- パネル：アクセサリー -->
  <div id="accessoryPanel" class="panel" aria-hidden="true">
    <div class="card">
      <h2 id="accTitle">アクセサリー</h2>
      <div id="accList" class="grid"></div>
      <div style="text-align:right;margin-top:8px"><button id="accClose">閉じる</button></div>
    </div>
  </div>

  <!-- パネル：コレクション -->
  <div id="collectionPanel" class="panel" aria-hidden="true">
    <div class="card">
      <h2 id="colTitle">コレクション</h2>
      <div id="collectionSummary" style="margin:6px 0 12px;color:#333"></div>
      <h3 id="colCommonTitle">よくある貝</h3>
      <div id="colCommon" class="grid" style="margin-bottom:12px"></div>
      <h3 id="colRareTitle">レア</h3>
      <div id="colRare" class="grid"></div>
      <div style="text-align:right;margin-top:8px"><button id="colClose">閉じる</button></div>
    </div>
  </div>

  <!-- 会話APIラッパ（フロント） ※/web/talk.js を読み込む -->
  <script src="./web/talk.js"></script>

  <script>
/* ===== i18n（ja/en/zh/ko） ===== */
const I18N = {
  ja:{about:'研究について',langBtn:'EN',heroTitle:'朝日の海へようこそ',start:'スタート',cont:'続きから',chooseChar:'キャラを選んでね',toastSunrise:'朝日がきれいだね',toNight:'夜へ',accessory:'アクセサリー',collection:'コレクション',reset:'リセット',nightTitle:'また明日',nightPH:'夜空を見ながら、何を話そう？',send:'送信',close:'閉じる',colTitle:'コレクション',colCommon:'よくある貝',colRare:'レア',beachGuide:'砂の中に貝があるよ。なでて探してね',nightGuide:'夜の海。話そうか？'},
  en:{about:'About this research',langBtn:'日本語',heroTitle:'Welcome to the Sunrise Shore',start:'Start',cont:'Continue',chooseChar:'Choose your character',toastSunrise:'Beautiful sunrise',toNight:'To Night',accessory:'Accessories',collection:'Collection',reset:'Reset',nightTitle:'See you tomorrow',nightPH:'What shall we talk about under the night sky?',send:'Send',close:'Close',colTitle:'Collection',colCommon:'Common Shells',colRare:'Rare',beachGuide:'Shells hide in the sand. Swipe to find them.',nightGuide:"It's night by the sea. Shall we talk?"},
  zh:{about:'关于研究',langBtn:'日本語',heroTitle:'欢迎来到朝阳之海',start:'开始',cont:'继续',chooseChar:'请选择角色',toastSunrise:'朝阳真美',toNight:'前往夜晚',accessory:'配饰',collection:'收藏',reset:'重置',nightTitle:'明天见',nightPH:'在夜空下聊点什么？',send:'发送',close:'关闭',colTitle:'收藏',colCommon:'常见贝壳',colRare:'稀有',beachGuide:'贝壳藏在沙子里，试着抚摸寻找吧',nightGuide:'夜晚的海边。要聊聊吗？'},
  ko:{about:'연구 소개',langBtn:'日本語',heroTitle:'아침 해변에 오신 것을 환영합니다',start:'시작',cont:'이어서',chooseChar:'캐릭터를 선택하세요',toastSunrise:'아침 해가 아름답네',toNight:'밤으로',accessory:'액세서리',collection:'컬렉션',reset:'리셋',nightTitle:'내일 또 보자',nightPH:'밤하늘을 보며 무엇을 이야기할까?',send:'보내기',close:'닫기',colTitle:'컬렉션',colCommon:'보통 조개',colRare:'레어',beachGuide:'모래 속에 조개가 있어요. 쓸어보며 찾아봐요',nightGuide:'밤바다예요. 이야기할까?'}
};
const $=(s,p=document)=>p.querySelector(s); const $$=(s,p=document)=>Array.from(p.querySelectorAll(s));
const toast=$('#toast'); const say=s=>toast.textContent=s;
const getLang=()=>localStorage.getItem('whoai.lang')||'ja';
function setLang(lang){
  const L=I18N[lang]||I18N.ja; document.documentElement.setAttribute('lang',lang); localStorage.setItem('whoai.lang',lang);
  $('#btnAbout').textContent=L.about; $('#btnLang').textContent=L.langBtn;
  $('#heroTitle').textContent=L.heroTitle; $('#btnHeroStart').textContent=L.start; $('#btnHeroContinue').textContent=L.cont;
  $('#btnNight').textContent=L.toNight; $('#btnAccessory').textContent=L.accessory; $('#btnCollection').textContent=L.collection; $('#btnReset').textContent=L.reset;
  $('#charTitle').textContent=L.chooseChar; $('#nightTitle').textContent=L.nightTitle; $('#chatInput').placeholder=L.nightPH; $('#chatSend').textContent=L.send;
  $('#accTitle').textContent=L.accessory; $('#colTitle').textContent=L.colTitle; $('#colCommonTitle').textContent=L.colCommon; $('#colRareTitle').textContent=L.colRare;
  say(L.toastSunrise);
}
function toggleLang(){ const order=['ja','en','zh','ko']; const cur=getLang(); const idx=order.indexOf(cur); setLang(order[(idx+1)%order.length]); }

/* ===== シーン ===== */
const bg={sunrise:$('#bg-sunrise'),beach:$('#bg-beach'),night:$('#bg-night')};
let currentScene='sunrise';
function scene(name){
  Object.values(bg).forEach(e=>e.classList.remove('show'));
  (bg[name]||bg.sunrise).classList.add('show');
  currentScene=name;
  store.set('whoai.lastScene',name);
  if(name==='beach'){ sand.classList.add('show'); $('#bucket').classList.add('show'); resizeSand(); say(I18N[getLang()].beachGuide); }
  else{ sand.classList.remove('show'); $('#bucket').classList.remove('show'); if(name==='night') say(I18N[getLang()].nightGuide); }
}

/* ===== ストレージ ===== */
const store={ get:(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch{return d;}}, set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch{}} };

/* ===== Hero ボタン ===== */
const hero=$('#hero'), gameUi=$('#gameUi');
$('#btnHeroStart').onclick=()=>{ openCharPanel(); };
$('#btnHeroContinue').onclick=()=>{ continueGame(); };
$('#btnAbout').onclick=()=>{ location.href='about/'; };
$('#btnLang').onclick=()=>{ toggleLang(); };

/* ===== キャラ選択 → 自動ビーチ ===== */
const whoaiWrap=$('#whoaiWrap'), whoai=$('#whoai'), accLayer=$('#accLayer'), bubble=$('#bubble');
function showBubble(t){ bubble.textContent=t; bubble.classList.add('show'); setTimeout(()=>bubble.classList.remove('show'),1300); }

const CHAR_LIST=[
  'blue_closed.png','green_open.png','orange_closed.png','pink_closed.png','purple_closed.png',
  'tane_green.png','tane_pink.png','tane_purple.png','tane_blue.png'
].map(n=>`./public/assets/stage1/${n}`);

const charPanel=$('#charPanel'), charGrid=$('#charGrid'); $('#charClose').onclick=()=>closePanel(charPanel);

function openCharPanel(){
  if(!charGrid.dataset.ready){
    CHAR_LIST.forEach(src=>{
      const d=document.createElement('div');
      d.className='choice';
      d.innerHTML=`<img src="${src}" alt=""><div>${src.split('/').pop().replace('.png','')}</div>`;
      d.onclick=()=>startGameWithChar(src);
      charGrid.appendChild(d);
    });
    charGrid.dataset.ready='1';
  }
  openPanel(charPanel);
  hero.style.pointerEvents='none'; // ヒーロー下のクリックを遮断
}

function selectChar(src){
  whoai.src=src;
  whoaiWrap.style.display='block';
  whoaiWrap.style.left='10vw';
  whoaiWrap.style.bottom='12vh';
  store.set('whoai.char',src);
  closePanel(charPanel);
  hero.style.pointerEvents='';
  showBubble('おはよう！');
  ensureWander();
  restoreAccessories();
}

function startGameWithChar(src){
  selectChar(src);
  hero.style.display='none';
  gameUi.classList.add('show');
  scene('beach');
}

function continueGame(){
  const saved=store.get('whoai.char',null);
  const last=store.get('whoai.lastScene','beach');
  if(!saved){ openCharPanel(); say(I18N[getLang()].chooseChar); return; }
  whoai.src=saved; whoaiWrap.style.display='block';
  ensureWander(); restoreAccessories();
  hero.style.display='none'; gameUi.classList.add('show');
  if(last==='night'){ scene('night'); openNight(); } else { scene('beach'); }
}

/* ===== アクセ解放ルール ===== */
const UNLOCK_RULES = [
  {key:'knit_hat',     need:3},
  {key:'straw_hat',    need:6},
  {key:'sunglasses',   need:9},
  {key:'ribbon_yellow',need:12},
  {key:'star_yellow',  need:15},
];
function getUnlocked(){ return new Set(store.get('whoai.unlocked',[])); }
function setUnlocked(set){ store.set('whoai.unlocked', Array.from(set)); }
function checkUnlocks(total){
  const unlocked=getUnlocked(); let newly=[];
  UNLOCK_RULES.forEach(r=>{ if(total>=r.need && !unlocked.has(r.key)){ unlocked.add(r.key); newly.push(r.key); }});
  if(newly.length){ setUnlocked(unlocked); openAccessory(true); say('アクセサリーが解放されたよ！'); }
}

/* ===== アクセサリー ===== */
const ACCESSORIES=[
  {key:'straw_hat',name:'麦わら帽子',src:'./public/accessories/straw_hat.png',cls:'straw_hat'},
  {key:'knit_hat',name:'毛糸の帽子',src:'./public/accessories/knit_hat.png',cls:'knit_hat'},
  {key:'sunglasses',name:'サングラス',src:'./public/accessories/sunglasses.png',cls:'sunglasses'},
  {key:'ribbon_yellow',name:'黄色いリボン',src:'./public/accessories/ribbon_yellow.png',cls:'ribbon_yellow'},
  {key:'star_yellow',name:'黄色のスター',src:'./public/accessories/star_yellow.png',cls:'star_yellow'},
];
const accessoryPanel=$('#accessoryPanel'), accList=$('#accList'); $('#accClose').onclick=()=>closePanel(accessoryPanel);

function openAccessory(forceRefresh=false){
  const unlocked=getUnlocked();
  if(!accList.dataset.ready || forceRefresh){
    accList.innerHTML='';
    ACCESSORIES.forEach(a=>{
      const rule=UNLOCK_RULES.find(r=>r.key===a.key);
      const isUnlocked=unlocked.has(a.key);
      const need=rule?rule.need:0;

      const item=document.createElement('div');
      item.className='accChoice'+(isUnlocked?'':' locked');
      item.innerHTML=`
        <img src="${a.src}" alt="${a.name}" style="width:80px;height:auto;display:block;margin:0 auto 6px">
        <div class="t" style="text-align:center;font-weight:700">${a.name}</div>
        <div class="meta">${isUnlocked ? 'タップで装着/解除' : `あと ${Math.max(0,need-totalCollected())} 個で解放`}</div>
        <input type="checkbox" ${isUnlocked?'':'disabled'} style="display:block;margin:8px auto 0">
      `;
      const cb=item.querySelector('input');
      cb.addEventListener('change',()=>toggleAccessory(a,cb.checked));
      item.addEventListener('click',e=>{
        if(!isUnlocked) return;
        if(e.target.tagName!=='INPUT'){ cb.checked=!cb.checked; cb.dispatchEvent(new Event('change')); }
      });
      item.dataset.key=a.key;
      accList.appendChild(item);
    });
    accList.dataset.ready='1';
  }
  // 反映（保存済み装着）
  const active=new Set(store.get('whoai.accessories',[]));
  $$('.accChoice',accList).forEach(div=>{
    const key=div.dataset.key; const cb=div.querySelector('input');
    if(cb) cb.checked=active.has(key);
  });
  openPanel(accessoryPanel);
}

function toggleAccessory(a,on){
  const active=new Set(store.get('whoai.accessories',[]));
  if(on){ active.add(a.key); addAccImg(a); } else { active.delete(a.key); removeAccImg(a.key); }
  store.set('whoai.accessories',Array.from(active));
}
function addAccImg(a){ removeAccImg(a.key); const img=document.createElement('img'); img.src=a.src; img.alt=a.name; img.className='acc '+(a.cls||''); img.dataset.key=a.key; accLayer.appendChild(img); }
function removeAccImg(key){ const el=accLayer.querySelector(`.acc[data-key="${key}"]`); if(el) el.remove(); }
function restoreAccessories(){ const active=store.get('whoai.accessories',[]); ACCESSORIES.forEach(a=>{ if(active.includes(a.key)) addAccImg(a); }); }

/* ===== 砂 & 貝（総出現 20） ===== */
const sand=document.getElementById('sand'); const ctx=sand.getContext('2d',{willReadFrequently:true});
function resizeSand(){
  sand.width=innerWidth; sand.height=innerHeight;
  const g=ctx.createLinearGradient(0,0,0,sand.height);
  g.addColorStop(0,'#e7d9b7'); g.addColorStop(1,'#c8b68f');
  ctx.fillStyle=g; ctx.fillRect(0,0,sand.width,sand.height);
  ctx.globalAlpha=.12;
  for(let i=0;i<800;i++){
    const x=Math.random()*sand.width, y=Math.random()*sand.height;
    ctx.fillStyle=(i%3===0)?'#bfae82':'#d2c29a';
    ctx.beginPath(); ctx.arc(x,y,Math.random()*1.2+.2,0,Math.PI*2); ctx.fill();
  }
  ctx.globalAlpha=1;
}
const BRUSH=30;
function brushAt(x,y){
  ctx.globalCompositeOperation='destination-out';
  ctx.globalAlpha=.35; ctx.beginPath(); ctx.arc(x,y,BRUSH,0,Math.PI*2); ctx.fill();
  ctx.globalAlpha=1; ctx.globalCompositeOperation='source-over';
  maybeSpawnNear(x,y);
}
sand.addEventListener('pointerdown',e=>{ if(currentScene==='beach'){ brushAt(e.clientX,e.clientY); }},{passive:false});
sand.addEventListener('pointermove',e=>{ if(currentScene==='beach'&&e.buttons){ brushAt(e.clientX,e.clientY); }},{passive:false});

const COMMON=['./public/items/asari1.png','./public/items/asari2.png','./public/items/asari3.png'];
const RARE=['./public/items/aurora_shell.png','./public/items/rare_pearl.png','./public/items/rare_rainbow.png'];

const bucket=document.getElementById('bucket'); const counter=document.getElementById('counter');
let count=0, spawnedTotal=0; const shells=[];
const MAX_SHELLS=8, TOTAL_SPAWN_LIMIT=20, MIN_DIST=90, SPAWN_P=.18;

function tooClose(x,y){ return shells.some(s=>Math.hypot(s.x-x,s.y-y)<MIN_DIST); }
function avoidBucket(x,y){ const b=bucket.getBoundingClientRect(); const cx=(b.left+b.right)/2, cy=(b.top+b.bottom)/2; return Math.hypot(cx-x,cy-y)<120; }
function maybeSpawnNear(x,y){
  if(shells.length>=MAX_SHELLS) return;
  if(spawnedTotal>=TOTAL_SPAWN_LIMIT) return;
  if(Math.random()>SPAWN_P) return;

  let px=x+(Math.random()*2-1)*90, py=y+(Math.random()*2-1)*90;
  px=Math.max(60,Math.min(innerWidth-60,px));
  py=Math.max(100,Math.min(innerHeight-100,py));
  if(tooClose(px,py)||avoidBucket(px,py)) return;

  const rare=Math.random()<.18;
  const src=(rare?RARE:COMMON)[Math.floor(Math.random()*(rare?RARE.length:COMMON.length))];
  const key=src.split('/').pop().replace('.png','');

  const el=document.createElement('div');
  el.className='shell'; el.style.left=px+'px'; el.style.top=py+'px';
  el.style.backgroundImage=`url(${src})`;
  document.body.appendChild(el); requestAnimationFrame(()=>el.classList.add('show'));
  enableShellDrag(el,key);
  shells.push({el,x:px,y:py,key});
  spawnedTotal++; store.set('whoai.spawned',spawnedTotal);
}
function enableShellDrag(el,key){
  let pid=null,dx=0,dy=0;
  el.addEventListener('pointerdown',e=>{
    e.preventDefault();
    pid=e.pointerId; el.setPointerCapture(pid);
    dx=e.clientX-parseFloat(el.style.left); dy=e.clientY-parseFloat(el.style.top);
    el.classList.add('drag');
  },{passive:false});
  el.addEventListener('pointermove',e=>{
    if(e.pointerId!==pid) return; e.preventDefault();
    el.style.left=(e.clientX-dx)+'px'; el.style.top=(e.clientY-dy)+'px';
  },{passive:false});
  function finish(e){
    if(e.pointerId!==pid) return; e.preventDefault();
    el.classList.remove('drag'); el.releasePointerCapture(pid); pid=null;
    const b=bucket.getBoundingClientRect();
    const s=el.getBoundingClientRect();
    const hit=!(s.right<b.left||s.left>b.right||s.bottom<b.top||s.top>b.bottom);
    if(hit){
      el.remove();
      const i=shells.findIndex(o=>o.el===el); if(i>-1) shells.splice(i,1);
      counter.textContent=++count; persistCount(); updateCollection(key,1);
      showBubble(Math.random()<.2?'レアだよ！':'やったね！'); refreshCollectionView();
      checkUnlocks(totalCollected());           // ★貝数に応じてアンロック
    }
  }
  el.addEventListener('pointerup',finish,{passive:false});
  el.addEventListener('pointercancel',finish,{passive:false});
}

/* ===== コレクション ===== */
const collectionPanel=$('#collectionPanel'), colCommon=$('#colCommon'), colRare=$('#colRare'), collectionSummary=$('#collectionSummary'); $('#colClose').onclick=()=>closePanel(collectionPanel);
const ALL_ITEMS=[...COMMON,...RARE].map(src=>({key:src.split('/').pop().replace('.png',''),src}));
function getCollection(){return store.get('whoai.collection',{});} function setCollection(o){store.set('whoai.collection',o);}
function updateCollection(key,d){const c=getCollection(); c[key]=(c[key]||0)+(d||0); if(c[key]<0)c[key]=0; setCollection(c);}
function totalCollected(){return Object.values(getCollection()).reduce((a,b)=>a+b,0);}
function buildCollectionGrid(){
  colCommon.innerHTML=''; COMMON.forEach(src=>{
    const key=src.split('/').pop().replace('.png','');
    const slot=document.createElement('div'); slot.className='slot';
    slot.innerHTML=`<div class="thumb" style="background-image:url(${src});width:80px;height:80px;background-size:contain;background-repeat:no-repeat;background-position:center;margin:auto"></div><div class="name" style="text-align:center">${key}</div><div class="count" style="text-align:center">×<span data-key="${key}">0</span></div>`;
    colCommon.appendChild(slot);
  });
  colRare.innerHTML=''; RARE.forEach(src=>{
    const key=src.split('/').pop().replace('.png','');
    const slot=document.createElement('div'); slot.className='slot';
    slot.innerHTML=`<div class="thumb" style="background-image:url(${src});width:80px;height:80px;background-size:contain;background-repeat:no-repeat;background-position:center;margin:auto"></div><div class="name" style="text-align:center">${key}</div><div class="count" style="text-align:center">×<span data-key="${key}">0</span></div>`;
    colRare.appendChild(slot);
  });
}
function refreshCollectionView(){
  const col=getCollection();
  const totalKinds=ALL_ITEMS.length;
  const ownedKinds=ALL_ITEMS.filter(x=>(col[x.key]||0)>0).length;
  const total=totalCollected();
  collectionSummary.textContent=`入手種: ${ownedKinds}/${totalKinds}　総数: ${total}　コンプ率: ${Math.round(ownedKinds/totalKinds*100)}%`;
  $$('#collectionPanel .slot').forEach(slot=>{
    const span=slot.querySelector('.count span');
    const key=span && span.getAttribute('data-key');
    const c=(col[key]||0);
    span.textContent=c;
    slot.classList.toggle('has', c>0);
  });
}
function openCollection(){ if(!colCommon.dataset.ready){ buildCollectionGrid(); colCommon.dataset.ready='1'; } refreshCollectionView(); openPanel(collectionPanel); }

/* ===== 夜（半透明） ===== */
const nightPanel=$('#nightPanel'), chatLog=$('#chatLog'), chatInput=$('#chatInput'), chatSend=$('#chatSend'); $('#nightClose').onclick=()=>closePanel(nightPanel);
const chatHistory=[];
function addMsg(role,text){ const div=document.createElement('div'); div.className='msg '+(role==='user'?'me':'ai'); div.textContent=text; chatLog.appendChild(div); chatLog.scrollTop=chatLog.scrollHeight; }
function openNight(){ openPanel(nightPanel); if(!chatLog.dataset.greet){ addMsg('ai',I18N[getLang()].nightGuide); chatLog.dataset.greet='1'; } }
chatSend.onclick=async()=>{ const text=chatInput.value.trim(); if(!text) return; addMsg('user',text); chatInput.value=''; chatHistory.push({role:'user',content:text});
  try{ const { reply } = await WHOAI_TALK.talk(text,{ history:chatHistory, state:{ totalCollected:count } }); addMsg('ai',reply||'…'); if(reply) chatHistory.push({role:'assistant',content:reply}); }catch(e){ addMsg('ai','（接続エラー）'); console.error(e); }
};
chatInput.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); chatSend.click(); } });

/* ===== 共通UI ===== */
function openPanel(p){ p.classList.add('show'); p.setAttribute('aria-hidden','false'); }
function closePanel(p){ p.classList.remove('show'); p.setAttribute('aria-hidden','true'); }
let wanderTimer=null; function ensureWander(){ if(wanderTimer) return; wanderTimer=setInterval(()=>{ whoaiWrap.style.left=(8+Math.random()*72)+'vw'; whoaiWrap.style.bottom=(10+Math.random()*60)+'vh'; },5000); }
document.getElementById('btnNight').onclick=()=>{ scene('night'); openNight(); };
document.getElementById('btnReset').onclick=()=>{ count=0; store.set('whoai.count',count); counter.textContent=0; $$('.shell').forEach(e=>e.remove()); spawnedTotal=0; store.set('whoai.spawned',spawnedTotal); if(currentScene==='beach'){ resizeSand(); } say('リセットしたよ'); };
document.getElementById('btnAccessory').onclick=()=>{ if(getComputedStyle(whoaiWrap).display==='none') selectChar(store.get('whoai.char','./public/assets/stage1/green_open.png')); openAccessory(); };
document.getElementById('btnCollection').onclick=()=> openCollection();
function persistCount(){ store.set('whoai.count',count); }

/* ===== 初期化 ===== */
function init(){
  setLang(getLang());
  scene('sunrise');                 // 背景は朝日
  whoaiWrap.style.display='none';   // キャラ非表示
  document.getElementById('bucket').classList.remove('show'); // バケツ非表示
  gameUi.classList.remove('show');  // フッター非表示

  // 続きからボタンの状態
  const hasSave=!!store.get('whoai.char',null);
  const btnCont=document.getElementById('btnHeroContinue');
  btnCont.disabled=!hasSave; btnCont.style.opacity=hasSave?'1':'.5'; btnCont.title=hasSave?'':'まだ保存がありません';

  // カウント復元
  count=store.get('whoai.count',0)||0; counter.textContent=count;
  spawnedTotal=store.get('whoai.spawned',0)||0;
  // 初回アンロック更新
  checkUnlocks(totalCollected());
}
addEventListener('resize',()=>{ if(currentScene==='beach') resizeSand(); });
init();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>WHOAI Gem</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
  body,html{margin:0;padding:0;height:100%;overflow:hidden;font-family:sans-serif;background:#000;color:#fff;touch-action:none}
  .bg{position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-position:center;transition:opacity 1s}
  .hide{opacity:0;pointer-events:none}

  #titleScreen{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:20;background:rgba(0,0,0,0.4)}
  #titleScreen h1{font-size:clamp(24px,6vw,48px);margin:0 0 20px}
  #titleScreen button{padding:10px 20px;border:none;border-radius:12px;font-size:18px;cursor:pointer}

  .whoai{position:absolute;bottom:12vh;left:10vw;width:clamp(80px,12vw,140px);user-select:none;animation:hop 2s infinite;transition:all 4s ease-in-out}
  @keyframes hop{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}

  .bucket{position:absolute;right:2vw;bottom:6vh;width:clamp(72px,14vw,140px)}
  .bucket img{width:100%;height:auto}
  #counter{position:absolute;right:calc(2vw + 40px);bottom:calc(6vh + 40px);font-size:clamp(16px,2vw,24px);background:#fff;color:#111;padding:6px 12px;border-radius:50%}

  .ui{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:6px;z-index:10}
  .ui button{padding:6px 10px;border-radius:12px;border:none;cursor:pointer}
  #toast{position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.6);padding:6px 12px;border-radius:6px;z-index:10}
  #langSel{position:absolute;top:10px;right:10px;z-index:10}

  .shell,.macaron{position:absolute;width:60px;height:60px;background-size:contain;background-repeat:no-repeat;background-position:center;cursor:grab;user-select:none;touch-action:none}
  .speech{position:absolute;padding:6px 12px;border-radius:12px;font-size:14px;white-space:nowrap;animation:fadeout 3s forwards}
  .speech.day{background:#fff;color:#000}
  .speech.night{background:#fff;color:#000}
  @keyframes fadeout{0%{opacity:1;transform:translate(-50%,-100%)}100%{opacity:0;transform:translate(-50%,-150%)}}

  canvas#sand{position:absolute;top:0;left:0;width:100%;height:100%;z-index:5;touch-action:none}
</style>
</head>
<body>
  <!-- 背景 -->
  <div id="bg-sunrise" class="bg" style="background-image:url('./public/bg/sunrise.jpg')"></div>
  <div id="bg-beach"   class="bg hide" style="background-image:url('./public/bg/beach_day.jpg')"></div>
  <div id="bg-night"   class="bg hide" style="background-image:url('./public/bg/night_beach.jpg')"></div>

  <!-- タイトル -->
  <div id="titleScreen">
    <h1>WHOAI Gem</h1>
    <button id="btnTitleStart">スタート</button>
  </div>

  <!-- WHOAIキャラ -->
  <img id="whoai" class="whoai hide" src="./public/assets/stage1/green_open.png" alt="whoai">

  <!-- バケツ -->
  <div class="bucket"><img id="bucketImg" src="./public/bucket.png" alt="bucket"></div>
  <div id="counter">0</div>

  <!-- 砂 Canvas -->
  <canvas id="sand" class="hide"></canvas>

  <!-- UI -->
  <div id="toast"></div>
  <div class="ui">
    <button id="btnStart">はじめる</button>
    <button id="btnCook">料理</button>
    <button id="btnAcc">アクセサリー</button>
    <button id="btnCol">コレクション</button>
    <button id="btnNight">夜へ</button>
  </div>
  <select id="langSel" aria-label="language">
    <option value="ja">日本語</option>
    <option value="en">English</option>
    <option value="ko">한국어</option>
    <option value="zh">中文</option>
  </select>

<script>
// ---------------- 状態 ----------------
let count=0, whoaiName="WHOAI", macaronGiven=false;
let currentScene="sunrise";
const COMMON=["./public/items/asari1.png","./public/items/asari2.png","./public/items/asari3.png"];
const MACARONS=["./public/items/macaroon1.png","./public/items/macaroon2.png","./public/items/macaroon3.png"];

// ---------------- 背景切替 ----------------
function showScene(id){
  document.querySelectorAll(".bg").forEach(bg=>bg.classList.add("hide"));
  document.getElementById(id).classList.remove("hide");
  currentScene=id.includes("night")?"night":"day";
  if(id==="bg-beach"){
    document.getElementById("sand").classList.remove("hide");
    initSand();spawnShells(5);wanderWhoai();
  }
}

// ---------------- 砂Canvas ----------------
const sand=document.getElementById("sand");
const ctx=sand.getContext("2d");
function resizeSand(){
  sand.width=innerWidth; sand.height=innerHeight;
  const g=ctx.createLinearGradient(0,0,0,sand.height);
  g.addColorStop(0,"#e7d9b7");g.addColorStop(1,"#c8b68f");
  ctx.fillStyle=g;ctx.fillRect(0,0,sand.width,sand.height);
}
function initSand(){resizeSand();}
function erase(x,y){
  ctx.globalCompositeOperation="destination-out";
  ctx.beginPath();ctx.arc(x,y,40,0,Math.PI*2);ctx.fill();
  ctx.globalCompositeOperation="source-over";
}
sand.addEventListener("pointerdown",e=>{erase(e.clientX,e.clientY)});
sand.addEventListener("pointermove",e=>{if(e.buttons) erase(e.clientX,e.clientY)});

// ---------------- 貝 ----------------
function spawnShells(n=5){
  for(let i=0;i<n;i++){
    const img=COMMON[Math.floor(Math.random()*COMMON.length)];
    const shell=document.createElement("div");
    shell.className="shell";
    shell.style.backgroundImage=`url(${img})`;
    shell.style.left=(Math.random()*70+10)+"%";
    shell.style.top=(Math.random()*40+40)+"%";
    shell.style.zIndex=4;
    document.body.appendChild(shell);
    makeDraggable(shell);
  }
}
function spawnMacaron(){
  if(macaronGiven) return;macaronGiven=true;
  const img=MACARONS[Math.floor(Math.random()*MACARONS.length)];
  const mac=document.createElement("div");
  mac.className="macaron";
  mac.style.backgroundImage=`url(${img})`;
  mac.style.left=(Math.random()*70+10)+"%";
  mac.style.top=(Math.random()*40+30)+"%";
  document.body.appendChild(mac);
}

// ---------------- ドラッグ ----------------
function makeDraggable(el){
  let dragging=false,offX=0,offY=0;
  el.addEventListener("pointerdown",e=>{dragging=true;offX=e.clientX-el.offsetLeft;offY=e.clientY-el.offsetTop;});
  window.addEventListener("pointermove",e=>{if(!dragging)return;el.style.left=(e.clientX-offX)+"px";el.style.top=(e.clientY-offY)+"px";});
  window.addEventListener("pointerup",()=>{
    if(!dragging)return;dragging=false;
    const b=document.getElementById("bucketImg").getBoundingClientRect();
    const r=el.getBoundingClientRect();
    if(r.left<b.right && r.right>b.left && r.top<b.bottom && r.bottom>b.top){
      el.remove();count++;document.getElementById("counter").textContent=count;
      showSpeech("やったね！");
      if(count===10){showSpeech("ご褒美！マカロンをゲット");spawnMacaron();}
    }
  });
}

// ---------------- キャラ ----------------
function wanderWhoai(){
  const w=document.getElementById("whoai");w.classList.remove("hide");
  setInterval(()=>{
    w.style.left=Math.random()*70+10+"%";
    w.style.bottom=(10+Math.random()*60)+"vh"; // ← 上の方まで移動可能
  },5000);
}
function showSpeech(text){
  const w=document.getElementById("whoai");const r=w.getBoundingClientRect();
  const sp=document.createElement("div");sp.className=`speech ${currentScene}`;
  sp.textContent=text;sp.style.left=(r.left+r.width/2)+"px";sp.style.top=r.top+"px";
  document.body.appendChild(sp);setTimeout(()=>sp.remove(),2500);
}
function askName(){
  const name=prompt("キャラに名前をつけてください",whoaiName);
  if(name) whoaiName=name;
  showSpeech(`${whoaiName}「またあした。星を見ながら語ろう」`);
}

// ---------------- UI ----------------
document.getElementById("btnTitleStart").onclick=()=>{document.getElementById("titleScreen").style.display="none";showScene("bg-sunrise");};
document.getElementById("btnStart").onclick=()=>showScene("bg-beach");
document.getElementById("btnNight").onclick=()=>{showScene("bg-night");askName();};
document.getElementById("btnCook").onclick=()=>alert("料理シーンへ");
document.getElementById("btnAcc").onclick=()=>alert("アクセサリーシーンへ");
document.getElementById("btnCol").onclick=()=>alert("コレクションシーンへ");

// ---------------- Init ----------------
resizeSand();
</script>
</body>
</html>

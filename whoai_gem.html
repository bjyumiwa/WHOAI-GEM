<!DOCTYPE html>
<html lang="ja" data-lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>WHOAI Gem</title>
  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#000;color:#fff;font-family:system-ui,"Noto Sans JP",sans-serif;touch-action:none;overscroll-behavior:none}
    .bg{position:fixed;inset:0;background-size:cover;background-position:center;opacity:0;transition:opacity .7s}
    .bg.show{opacity:1}

    /* Topbar */
    #topbar{position:fixed;left:0;right:0;top:0;z-index:40;display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,0))}
    #topbar .left,#topbar .right{display:flex;gap:8px}
    #topbar button{padding:6px 10px;border:none;border-radius:10px;background:rgba(255,255,255,.92);color:#111;cursor:pointer}

    /* Hero */
    #hero{position:fixed;inset:0;z-index:30;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;text-align:center;background:rgba(0,0,0,.15)}
    #hero h1{font-size:clamp(20px,4vw,36px);margin:0 16px;text-shadow:0 2px 8px rgba(0,0,0,.45)}
    .heroBtns{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
    .heroBtns button{padding:12px 18px;border:none;border-radius:12px;cursor:pointer;font-weight:700}

    /* キャラ */
    #whoaiWrap{position:fixed;left:10vw;bottom:12vh;z-index:5;touch-action:none;display:none;transition:left 4s ease, bottom 4s ease}
    #whoai{width:clamp(80px,12vw,140px);user-select:none;display:block}
    #accLayer{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}
    .bubble{position:absolute;left:50%;bottom:100%;transform:translate(-50%,-8px);background:rgba(255,255,255,.78);backdrop-filter:blur(2px);color:#111;border-radius:10px;padding:4px 8px;font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,.25);opacity:0;transition:.18s;white-space:nowrap}
    .bubble.show{opacity:1;transform:translate(-50%,-12px)}

    /* アクセサリー（小さめ＆位置調整） */
    .acc{position:absolute;left:50%;top:20%;transform:translate(-50%,-50%);width:25%;pointer-events:none;z-index:2}
    .acc.sunglasses{top:40%;width:40%}
    .acc.ribbon_yellow{top:18%;left:65%;width:20%}
    .acc.star_yellow{top:22%;left:70%;width:15%}
    .acc.straw_hat{top:10%;width:45%}
    .acc.knit_hat{top:15%;width:40%}

    /* バケツ */
    #bucket{position:fixed;right:2vw;bottom:7vh;z-index:4;width:clamp(74px,14vw,160px);display:none}
    #bucket.show{display:block}
    #bucket img{width:100%;display:block}
    #counter{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.9);color:#111;border-radius:999px;padding:4px 8px;font-weight:600}

    /* 砂 */
    #sand{position:fixed;inset:0;z-index:2;touch-action:none;display:none}
    #sand.show{display:block}

    /* 貝 */
    .shell{position:fixed;z-index:3;width:clamp(48px,6vw,72px);height:clamp(48px,6vw,72px);transform:translate(-50%,-50%);background-size:contain;background-repeat:no-repeat;background-position:center;cursor:grab;opacity:0;transition:opacity .18s, transform .18s}
    .shell.show{opacity:1}
    .shell.drag{transform:translate(-50%,-50%) scale(1.04)}

    /* トースト / フッターUI */
    #toast{position:fixed;right:10px;top:42px;z-index:20;background:rgba(255,255,255,.92);color:#111;padding:8px 12px;border-radius:10px;font-size:14px;min-width:180px}
    .ui{position:fixed;left:50%;bottom:10px;transform:translateX(-50%);display:none;gap:8px;z-index:10;flex-wrap:wrap;justify-content:center}
    .ui.show{display:flex}
    .ui button{padding:8px 14px;border:none;border-radius:10px;cursor:pointer}

    /* パネル */
    .panel{position:fixed;inset:0;z-index:12;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center}
    .panel.show{display:flex}
    .card{background:#fff;color:#111;border-radius:14px;padding:16px;width:min(92svw,720px)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:12px}
    .choice{border:1px solid #eee;border-radius:12px;padding:8px;text-align:center;cursor:pointer;transition:transform .12s}
    .choice:hover{transform:translateY(-2px)}
    .choice img{max-width:100%;height:auto;display:block;margin:0 auto 6px}

    /* 夜チャット */
    #nightPanel .card{width:min(96svw,640px);max-height:90vh;display:flex;flex-direction:column;backdrop-filter:blur(2px)}
    #chatLog{flex:1;background:rgba(242,242,242,.75);padding:10px;border-radius:10px;overflow:auto}
    .msg{margin:6px 0;padding:8px 12px;border-radius:16px;max-width:70%}
    .msg.me{background:rgba(174,225,255,.85);color:#002;margin-left:auto}
    .msg.ai{background:rgba(255,255,255,.85);color:#000;margin-right:auto}
    #chatCtrl{display:flex;gap:6px;margin-top:8px}
    #chatInput{flex:1;padding:10px;border-radius:12px;border:1px solid #ccc}
    #chatSend{padding:10px 14px;border:none;border-radius:12px;background:#4cafef;color:#fff;cursor:pointer}
  </style>
</head>
<body>
  <!-- 背景 -->
  <div id="bg-sunrise" class="bg show" style="background-image:url('./public/bg/sunrise.jpg')"></div>
  <div id="bg-beach"   class="bg"        style="background-image:url('./public/bg/beach_day.jpg')"></div>
  <div id="bg-night"   class="bg"        style="background-image:url('./public/bg/night_beach.jpg')"></div>

  <!-- Topbar -->
  <div id="topbar">
    <div class="left"><button id="btnAbout">研究について</button></div>
    <div class="right"><button id="btnLang">EN</button></div>
  </div>

  <!-- Hero -->
  <div id="hero">
    <h1 id="heroTitle">朝日の海へようこそ</h1>
    <div class="heroBtns">
      <button id="btnHeroStart">スタート</button>
      <button id="btnHeroContinue">続きから</button>
    </div>
  </div>

  <!-- キャラ -->
  <div id="whoaiWrap">
    <img id="whoai" src="" alt="whoai">
    <div id="accLayer"></div>
    <div id="bubble" class="bubble"></div>
  </div>

  <!-- バケツ -->
  <div id="bucket">
    <img id="bucketImg" src="./public/bucket.png" alt="bucket">
    <div id="counter">0</div>
  </div>

  <!-- 砂 -->
  <canvas id="sand"></canvas>

  <!-- UI -->
  <div id="toast">朝日がきれいだね</div>
  <div class="ui" id="gameUi">
    <button id="btnNight">夜へ</button>
    <button id="btnAccessory">アクセサリー</button>
    <button id="btnCollection">コレクション</button>
    <button id="btnReset">リセット</button>
  </div>

  <!-- パネル（キャラ/夜/アクセ/コレクション） -->
  <div id="charPanel" class="panel"><div class="card"><h2 id="charTitle">キャラを選んでね</h2><div id="charGrid" class="grid"></div><div style="text-align:right;margin-top:8px"><button id="charClose">閉じる</button></div></div></div>
  <div id="nightPanel" class="panel"><div class="card"><h2 id="nightTitle">また明日</h2><div id="chatLog"></div><div id="chatCtrl"><input id="chatInput" type="text"><button id="chatSend">送信</button></div><div style="text-align:right;margin-top:8px"><button id="nightClose">閉じる</button></div></div></div>
  <div id="accessoryPanel" class="panel"><div class="card"><h2 id="accTitle">アクセサリー</h2><div id="accList" class="grid"></div><div style="text-align:right;margin-top:8px"><button id="accClose">閉じる</button></div></div></div>
  <div id="collectionPanel" class="panel"><div class="card"><h2 id="colTitle">コレクション</h2><div id="collectionSummary"></div><h3 id="colCommonTitle">よくある貝</h3><div id="colCommon" class="grid"></div><h3 id="colRareTitle">レア</h3><div id="colRare" class="grid"></div><div style="text-align:right;margin-top:8px"><button id="colClose">閉じる</button></div></div></div>

  <script src="./api/talk.js"></script>
<script>
/************** i18n **************/
const I18N = {
  ja:{about:'研究について',langBtn:'EN',heroTitle:'朝日の海へようこそ',start:'スタート',cont:'続きから',chooseChar:'キャラを選んでね',toastSunrise:'朝日がきれいだね',toNight:'夜へ',accessory:'アクセサリー',collection:'コレクション',reset:'リセット',nightTitle:'また明日',nightPH:'夜空を見ながら、何を話そう？',send:'送信',close:'閉じる',colTitle:'コレクション',colCommon:'よくある貝',colRare:'レア',beachGuide:'砂の中に貝があるよ。なでて探してね',nightGuide:'夜の海。話そうか？'},
  en:{about:'About this research',langBtn:'日本語',heroTitle:'Welcome to the Sunrise Shore',start:'Start',cont:'Continue',chooseChar:'Choose your character',toastSunrise:'Beautiful sunrise',toNight:'To Night',accessory:'Accessories',collection:'Collection',reset:'Reset',nightTitle:'See you tomorrow',nightPH:'What shall we talk about under the night sky?',send:'Send',close:'Close',colTitle:'Collection',colCommon:'Common Shells',colRare:'Rare',beachGuide:'Shells hide in the sand. Swipe to find them.',nightGuide:\"It's night by the sea. Shall we talk?\"}
};
const $=(s,p=document)=>p.querySelector(s); const $$=(s,p=document)=>Array.from(p.querySelectorAll(s));
const toast=$('#toast'); const say=s=>toast.textContent=s;
const getLang=()=>localStorage.getItem('whoai.lang')||'ja';
function setLang(lang){ ... } // （ここは前回と同じ内容、省略可）

/************** シーン管理 **************/
const bg={sunrise:$('#bg-sunrise'),beach:$('#bg-beach'),night:$('#bg-night')}; let currentScene='sunrise';
function scene(name){ ... } // （同上、省略）

/************** Heroボタン **************/
const hero=$('#hero'), gameUi=$('#gameUi');
$('#btnHeroStart').onclick=()=>{ openCharPanel(); };
$('#btnHeroContinue').onclick=()=>{ continueGame(); };
$('#btnAbout').onclick=()=>{ location.href='about/'; };   // ← 修正済み
$('#btnLang').onclick=()=>{ toggleLang(); };

/************** キャラ選択 **************/
const whoaiWrap=$('#whoaiWrap'), whoai=$('#whoai'), accLayer=$('#accLayer'), bubble=$('#bubble');
function showBubble(t){ ... } // （省略）
const CHAR_LIST=[...]; // （キャラ画像リスト）
function openCharPanel(){ ... }
function selectChar(src){ ... }
function startGameWithChar(src){ ... }
function continueGame(){ ... }
init();
</script>
</body>
</html>
